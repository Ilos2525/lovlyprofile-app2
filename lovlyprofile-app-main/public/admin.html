<!DOCTYPE html>
<html lang="ru">
<head>
  <!-- Обновлённый CSP -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self' https://*.firebaseapp.com https://*.googleapis.com https://www.gstatic.com https://apis.google.com https://ritrag.com data: blob:;
  script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.firebaseapp.com https://*.googleapis.com https://www.gstatic.com https://apis.google.com https://ritrag.com;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
  font-src 'self' https://fonts.gstatic.com;
  img-src 'self' data: https://* blob:;
  connect-src 'self' https://*.firebaseio.com https://*.googleapis.com https://accounts.google.com https://ritrag.com wss://*.firebaseio.com;
">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Админ-панель | whylovly</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --neon-color: #00ffcc;
      --bg-dark: #121212;
      --bg-card: rgba(0, 0, 0, 0.3);
      --text-color: #ffffff;
      --error-color: #ff4444;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: var(--bg-dark);
      color: var(--text-color);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }

    /* СТИЛИ ИНТЕРФЕЙСА - КОПИРУЕМ ИЗ ПЕРВОГО КОДА */
    .admin-header {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 20px;
      background: var(--bg-card);
      border-radius: 15px;
      border: 1px solid var(--neon-color);
      margin-bottom: 30px;
    }
    .profile-photo {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--neon-color);
    }
    .profile-info h2 {
      margin: 0;
      color: var(--neon-color);
    }
    .profile-info p {
      margin: 5px 0;
      opacity: 0.8;
    }
    .admin-tabs {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    .tab-button {
      background: var(--bg-card);
      border: 1px solid var(--neon-color);
      color: var(--text-color);
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      min-width: 150px;
    }
    .tab-button:hover {
      background: rgba(0, 255, 204, 0.1);
      transform: translateY(-2px);
    }
    .tab-button.active {
      background: var(--neon-color);
      color: var(--bg-dark);
    }
    .form-group {
      background: var(--bg-card);
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid var(--neon-color);
      box-shadow: 0 0 20px rgba(0, 255, 204, 0.1);
    }
    .preview-container {
      margin: 15px 0;
      max-width: 300px;
      border-radius: 8px;
      overflow: hidden;
    }
    .preview-container img {
      width: 100%;
      height: auto;
      border-radius: 8px;
    }
    .preview-container audio {
      width: 100%;
      margin: 10px 0;
    }
    .video-preview {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
    }
    .video-preview img {
      position: absolute;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .video-preview .play-icon {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 48px;
      color: white;
      text-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    h3 {
      color: var(--neon-color);
      margin-top: 0;
      font-size: 1.5em;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin: 15px 0 8px;
      color: var(--text-color);
      font-weight: 500;
    }
    select, input, textarea {
      width: 100%;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--neon-color);
      color: var(--text-color);
      border-radius: 8px;
      font-family: inherit;
      transition: all 0.3s ease;
    }
    select:focus, input:focus, textarea:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(0, 255, 204, 0.3);
    }
    button {
      background: var(--neon-color);
      color: var(--bg-dark);
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .progress-bar {
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      margin: 20px 0;
      border-radius: 3px;
      overflow: hidden;
    }
    .progress {
      height: 100%;
      background: var(--neon-color);
      width: 0%;
      transition: width 0.3s ease;
    }
    #loginForm {
      text-align: center;
      max-width: 400px;
      margin: 50px auto;
      padding: 30px;
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--neon-color);
      box-shadow: 0 0 30px rgba(0, 255, 204, 0.2);
    }
    .post-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .post-item {
      background: var(--bg-card);
      border: 1px solid var(--neon-color);
      border-radius: 12px;
      overflow: hidden;
      transition: transform 0.3s ease;
    }
    .post-item:hover {
      transform: translateY(-5px);
    }
    .post-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid rgba(0, 255, 204, 0.2);
    }
    .post-content {
      padding: 15px;
    }
    .post-media {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }
    .delete-btn {
      background: var(--error-color);
      padding: 8px 16px;
      width: auto;
      margin: 0;
      color: white;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      .admin-tabs {
        flex-direction: column;
      }
      .tab-button {
        width: 100%;
      }
    }
    .stats-block {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .stat-item {
      background: var(--bg-card);
      border: 1px solid var(--neon-color);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    .stat-number {
      font-size: 2.5em;
      color: var(--neon-color);
      margin: 10px 0;
    }
    .stat-item h4 {
      margin: 0;
      color: var(--text-color);
      opacity: 0.8;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .comments-list {
      margin-top: 20px;
    }
    .comment-item {
      background: var(--bg-card);
      border: 1px solid var(--neon-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .comment-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .comment-author {
      color: var(--neon-color);
      font-weight: 500;
    }
    .comment-date {
      opacity: 0.7;
    }
    .comment-text {
      margin: 0;
    }
    .detailed-stats {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    .post-stats {
      background: var(--bg-card);
      border: 1px solid var(--neon-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .visitor-item {
      background: var(--bg-card);
      border: 1px solid var(--neon-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .visitor-photo {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    .visitor-info {
      flex-grow: 1;
    }
    .visitor-email {
      color: var(--neon-color);
      font-weight: 500;
    }
    .visitor-date {
      opacity: 0.7;
      font-size: 0.9em;
    }
    .activity-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .activity-tab {
      background: var(--bg-card);
      border: 1px solid var(--neon-color);
      color: var(--text-color);
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }
    .activity-tab.active {
      background: var(--neon-color);
      color: var(--bg-dark);
    }
    .post-stat-item {
      background: var(--bg-card);
      border: 1px solid var(--neon-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .post-stat-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .post-stat-details {
      margin-top: 10px;
    }
    .user-activity-item {
      background: var(--bg-card);
      border: 1px solid var(--neon-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .user-photo {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    .activity-info {
      flex-grow: 1;
    }
    .activity-date {
      color: var(--neon-color);
      font-size: 0.9em;
    }
/* ==== QUIZ BUILDER ==== */
.q-block{
  border:1px solid var(--neon-color);
  border-radius:8px;padding:15px;margin-bottom:15px;
  position:relative
}
.q-block h5{margin:0 0 10px;font-weight:500;color:var(--neon-color)}
.q-block .del{
  position:absolute;top:8px;right:8px;
  background:transparent;border:none;color:#ff5555;font-size:18px;cursor:pointer
}
.q-block input[type="file"]{margin-bottom:10px}
.q-block .opt{display:flex;gap:6px;margin:4px 0}
.q-block .opt input[type="radio"]{margin-top:6px}

  </style>
</head>
<body>
  <!-- Форма входа -->
  <div id="loginForm">
    <h3>Вход в админ-панель</h3>
    <button id="googleSignIn">Войти через Google</button>
  </div>

  <!-- Основное содержимое админ-панели -->
  <div id="adminContent" style="display: none;">
    <!-- Шапка администратора -->
    <div class="admin-header">
      <img id="currentProfilePhoto" src="" alt="Profile" class="profile-photo">
      <div class="profile-info">
        <h2 id="currentProfileName">whylovly</h2>
        <p id="currentProfileBio">Музыкант | Создатель контента | Артист</p>
      </div>
    </div>

    <!-- Навигация по табам -->
    <div class="admin-tabs">
      <button class="tab-button active" onclick="showTab('posts')">Добавить пост</button>
      <button class="tab-button" onclick="showTab('manage')">Управление постами</button>
      <button class="tab-button" onclick="showTab('stats')">Статистика</button>
      <button class="tab-button" onclick="showTab('profile')">Профиль</button>
      <button class="tab-button" onclick="showTab('settings')">Настройки</button>
    </div>

<!-- Содержимое вкладки "Добавить пост" -->
<div id="posts" class="tab-content active">
  <div class="form-group">
    <h3>Добавить новый пост</h3>
    <form id="uploadForm">
      <label for="category">Категория:</label>
      <select id="category" required>
        <option value="photo">Фото</option>
        <option value="music">Музыка</option>
        <option value="video">Видео (YouTube)</option>
        <option value="uploaded_video">Видео (загруженное)</option>
      </select>

      <div id="fileInputGroup">
        <label for="fileInput">Файл:</label>
        <input type="file" id="fileInput" accept="image/*,video/*" multiple>
        <div class="preview-container" id="filePreview"></div>
      </div>

      <div id="youtubeLinkGroup" style="display: none;">
        <label for="youtubeLink">Ссылка на YouTube:</label>
        <input type="url" id="youtubeLink" placeholder="https://youtube.com/...">
        <div class="preview-container" id="youtubePreview"></div>
      </div>

      <label for="description">Описание:</label>
      <textarea id="description" rows="4" required></textarea>
      
 <!-- показываем только при music -->
<div id="musicMeta" style="display:none">
  <label for="trackDate">Дата трека:</label>
  <input type="date" id="trackDate">

  <label for="coverFile">Обложка трека:</label>
  <input type="file" id="coverFile" accept="image/*">
  <div class="preview-container" id="coverPreview"></div>
</div>

      <!-- ===== Блок настроек архива ===== -->
      <label style="margin-top:15px">
        <input type="checkbox" id="isArchive">
        Опубликовать в «Архиве»
      </label>

      <div id="archiveSettings" style="display:none; margin:10px 0 20px 20px; padding-left:10px; border-left:2px solid var(--neon-color);">
        <label for="archiveSeq">Номер задания (archiveSeq):</label>
        <input type="number" id="archiveSeq" min="1" placeholder="1">

        <label for="unlockType">Тип разблокировки:</label>
      <select id="unlockType">
  <option value="auto">auto (авто)</option>
  <option value="password">password</option>
  <option value="quiz">quiz</option>
  <option value="final">final (кнопка)</option>
  <option value="audio">audio</option>
  <option value="video">video</option>
</select>


        <div id="passwordGroup" style="display:none; margin-top:10px;">
          <label for="unlockPassword">Пароль:</label>
          <input type="text" id="unlockPassword" placeholder="A123">
        </div>

<div id="audioGroup" style="display:none; margin-top:10px;">
  <label for="unlockAudio">Аудио‑файл (mp3):</label>
  <!-- теперь фильтр по mp3 и всем аудио‑типам -->
  <input type="file" id="unlockAudio" accept=".mp3,audio/*">
</div>


        <div id="videoGroup" style="display:none;margin-top:10px;">
  <label for="unlockVideo">Видео‑файл (mp4):</label>
  <input type="file" id="unlockVideo" accept="video/*">
</div>


        <div id="quizGroup" style="display:none; margin-top:10px;">
  <h4>Викторина (до 10 вопросов)</h4>

  <div id="quizBuilder"></div>

  <button type="button" id="addQ" style="margin-top:12px">
    + Добавить вопрос
  </button>

  <!-- сюда автоматически кладём готовый JSON -->
  <input type="hidden" id="unlockQuiz">
</div>


  <label for="taskHint">Подсказка / текст задания:</label>
  <textarea id="taskHint" rows="3"></textarea>
</div>
      <!-- ===== /Блок архива ===== -->


      <div class="progress-bar">
        <div class="progress"></div>
      </div>

      <button type="submit">Опубликовать</button>
    </form>
  </div>
</div>

    <!-- Содержимое вкладки "Управление постами" -->
    <div id="manage" class="tab-content">
      <div class="form-group">
        <h3>Управление постами</h3>
        <div class="post-grid" id="postsList">
          <div class="loading">Загрузка постов...</div>
        </div>
      </div>
    </div>

    <!-- Содержимое вкладки "Профиль" -->
    <div id="profile" class="tab-content">
      <div class="form-group">
        <h3>Настройки профиля</h3>
        <form id="profileForm">
          <div class="profile-upload">
            <label for="profilePhoto">Фото профиля:</label>
            <input type="file" id="profilePhoto" accept="image/*">
            <div class="preview-container" id="profilePreview">
              <img id="currentProfilePhotoPreview" src="" alt="Preview">
            </div>
          </div>

          <label for="profileName">Имя профиля:</label>
          <input type="text" id="profileName" required>

          <label for="profileBio">Описание профиля:</label>
          <textarea id="profileBio" rows="3" required></textarea>

          <label for="socialLinks">Социальные сети:</label>
          <div id="socialLinks">
            <input type="url" placeholder="Instagram" name="instagram">
            <input type="url" placeholder="YouTube" name="youtube">
            <input type="url" placeholder="VK" name="vk">
          </div>

          <button type="submit">Сохранить изменения</button>
        </form>
      </div>
    </div>

    <!-- Содержимое вкладки "Настройки" -->
    <div id="settings" class="tab-content">
      <div class="form-group">
        <h3>Общие настройки</h3>
        <form id="settingsForm">
          <label for="siteTitle">Заголовок сайта:</label>
          <input type="text" id="siteTitle" required>

          <label for="accentColor">Цвет акцента:</label>
          <input type="color" id="accentColor" value="#00ffcc">

          <label for="headerImage">Фоновое изображение шапки:</label>
          <input type="file" id="headerImage" accept="image/*">
          <div class="preview-container" id="headerPreview"></div>

          <div class="form-group">
            <h4>Настройки главной страницы</h4>
            <label for="welcomeText">Приветственный текст:</label>
            <textarea id="welcomeText" rows="3"></textarea>

            <label for="featuredContent">Закрепленный контент:</label>
            <select id="featuredContent">
              <option value="">Не выбрано</option>
            </select>
          </div>

          <button type="submit">Применить настройки</button>
        </form>
      </div>
    </div>

    <!-- Содержимое вкладки "Статистика" -->
    <div id="stats" class="tab-content">
      <div class="form-group">
        <h3>Общая статистика</h3>
        <div class="stats-block">
          <div class="stat-item">
            <h4>Всего постов</h4>
            <div id="totalPosts" class="stat-number">0</div>
          </div>
          <div class="stat-item">
            <h4>Всего лайков</h4>
            <div id="totalLikes" class="stat-number">0</div>
          </div>
          <div class="stat-item">
            <h4>Комментариев</h4>
            <div id="totalComments" class="stat-number">0</div>
          </div>
          <div class="stat-item">
            <h4>Посетителей</h4>
            <div id="totalVisitors" class="stat-number">0</div>
          </div>
        </div>

          <!-- Секция статистики прохождений квестов -->
  <div class="form-group">
    <h3>Кто до какого уровня дошёл</h3>
    <table id="questStatsTable" style="width:100%; border-collapse: collapse; text-align: left;">
      <thead>
        <tr>
          <th style="border-bottom:1px solid var(--neon-color); padding:8px;">Пользователь</th>
          <th style="border-bottom:1px solid var(--neon-color); padding:8px;">Макс. уровень</th>
          <th style="border-bottom:1px solid var(--neon-color); padding:8px;">Дата последнего прохода</th>
        </tr>
      </thead>
      <tbody>
        <!-- сюда JS подставит строки -->
      </tbody>
    </table>
  </div>


        <!-- Детальная статистика по постам -->
        <div class="form-group">
          <h3>Статистика по постам</h3>
          <div id="detailedPostStats" class="detailed-stats">
            <!-- Сюда будет загружаться детальная статистика постов -->
          </div>
        </div>

        <!-- Активность пользователей -->
        <div class="form-group">
          <h3>Активность пользователей</h3>
          <div class="activity-tabs">
            <button class="activity-tab active" onclick="showActivityTab('likes')">Лайки</button>
            <button class="activity-tab" onclick="showActivityTab('comments')">Комментарии</button>
            <button class="activity-tab" onclick="showActivityTab('visits')">Посещения</button>
          </div>
          <div id="userActivity" class="user-activity">
            <!-- Сюда будет загружаться информация об активности -->
          </div>
        </div>
      </div>
    </div>
  </div>
<!-- Блок скриптов Firebase и основной логики -->
<script type="module">
  /* ====== Импорты Firebase ====== */
 import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getAuth, 
  GoogleAuthProvider, 
  signInWithPopup, // добавлено
  signInWithRedirect, 
  getRedirectResult, 
  onAuthStateChanged, 
  setPersistence, 
  browserLocalPersistence 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  doc,
  getDoc,
  setDoc,
  getDocs,
  addDoc,
  deleteDoc,
  query,
  where,
  orderBy,
  updateDoc,
  writeBatch,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  
  import { 
    getStorage, 
    ref, 
    uploadBytesResumable, 
    getDownloadURL 
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";


  /* ====== Конфигурация Firebase ====== */
  const firebaseConfig = {
    apiKey: "AIzaSyDPMqef3_hF-QpBr09qtry_45K4h28oMT0",
    authDomain: "whylovly-website-8adcb.firebaseapp.com",
    projectId: "whylovly-website-8adcb",
    storageBucket: "whylovly-website-8adcb.firebasestorage.app", 
    messagingSenderId: "749833792533",
    appId: "1:749833792533:web:2494649a11b628cd84321c"
  };

  /* ====== Инициализация Firebase ====== */
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  /* ====== Настраиваем локальное хранилище для сессии ====== */
  setPersistence(auth, browserLocalPersistence)
    .then(() => {
      console.log("Persistence set to LOCAL");
    })
    .catch((err) => {
      console.error("Error setting persistence:", err);
    });

  /* ====== Проверка редиректа (signInWithRedirect) ====== */
  getRedirectResult(auth)
    .then((result) => {
      if (result && result.user) {
        console.log("Успешный вход через редирект:", result.user.email);
        if (result.user.email === 'iosinniy1@gmail.com') {
          document.getElementById('loginForm').style.display = 'none';
          document.getElementById('adminContent').style.display = 'block';
        } else {
          auth.signOut();
          alert('Доступ запрещен.');
        }
      }
    })
    .catch((error) => {
      console.error('Ошибка после редиректа:', error);
    });

  /* ====== Обработчик кнопки "Войти через Google" ====== */
 document.getElementById('googleSignIn').addEventListener('click', async function() {
  try {
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });
    // Используем signInWithPopup вместо signInWithRedirect
    const result = await signInWithPopup(auth, provider);
    console.log("Popup sign-in successful:", result.user.email);

    // Если email соответствует администратору, показываем админ-панель
    if (result.user.email === 'iosinniy1@gmail.com') {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('adminContent').style.display = 'block';
      loadProfile();
    } else {
      auth.signOut();
      alert('Доступ запрещен.');
    }
  } catch (error) {
    console.error("Ошибка входа:", error.code, error.message, error);
    let errorMessage = 'Произошла ошибка при входе';

    switch (error.code) {
      case 'auth/popup-blocked':
        errorMessage = 'Пожалуйста, разрешите всплывающие окна для этого сайта';
        break;
      case 'auth/popup-closed-by-user':
        errorMessage = 'Вход был отменен. Пожалуйста, попробуйте снова';
        break;
      case 'auth/cancelled-popup-request':
        errorMessage = 'Предыдущий запрос на вход ещё выполняется';
        break;
      case 'auth/network-request-failed':
        errorMessage = 'Проверьте подключение к интернету';
        break;
    }

    alert(errorMessage);
  }
});


  /* ====== Слушатель состояния авторизации ====== */
  onAuthStateChanged(auth, (user) => {
    if (user && user.email === 'iosinniy1@gmail.com') {
      console.log("Администратор авторизован:", user.email);
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('adminContent').style.display = 'block';
      loadProfile(); // Загружаем профиль после авторизации
    } else {
      console.log("Пользователь не авторизован или не является администратором");
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('adminContent').style.display = 'none';
    }
  });

  /* ====== Система переключения вкладок (showTab) ====== */
  window.showTab = function(tabId) {
    document.querySelectorAll('.tab-content').forEach(section => {
      section.classList.remove('active');
    });
    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.classList.remove('active');
    });
    const targetTab = document.getElementById(tabId);
    const clickedBtn = document.querySelector(`[onclick="showTab('${tabId}')"]`);

    if (targetTab) targetTab.classList.add('active');
    if (clickedBtn) clickedBtn.classList.add('active');

     if (tabId === 'manage') loadPosts();
  if (tabId === 'stats') {
    loadStats();
    loadQuestStats();  // <-- добавили
  }
    
  };

// ====== Переключение типа поста (категория) ======
const categoryEl   = document.getElementById('category');
const fileInput    = document.getElementById('fileInput');
const fileGroup    = document.getElementById('fileInputGroup');
const ytGroup      = document.getElementById('youtubeLinkGroup');
const musicMeta    = document.getElementById('musicMeta');
const filePreview  = document.getElementById('filePreview');
const ytPreview    = document.getElementById('youtubePreview');

categoryEl.addEventListener('change', e => {
  const cat = e.target.value;

  // 1) Динамически задаём accept
  if (cat === 'uploaded_video') {
    fileInput.accept = 'video/*';
  } else if (cat === 'photo') {
    fileInput.accept = 'image/*,video/*';
  } else {
    // для music и остальных — только картинки
    fileInput.accept = 'image/*';
  }

  // 2) Прячет/показывает fileInput vs YouTube‑ссылку
  if (cat === 'video') {
    fileGroup.style.display = 'none';
    ytGroup.style.display   = 'block';
  } else {
    ytGroup.style.display   = 'none';
    fileGroup.style.display = 'block';
  }

  // 3) Мета‑блок для музыки
  musicMeta.style.display = (cat === 'music') ? 'block' : 'none';

  // 4) Сброс превью
  filePreview.innerHTML = '';
  ytPreview.innerHTML   = '';
});



// ====== Логика показа/скрытия полей Архива ======
// 1) Получаем элементы
const isArchiveCh     = document.getElementById('isArchive');
const archiveSettings = document.getElementById('archiveSettings');
const unlockType      = document.getElementById('unlockType');
const passwordGroup   = document.getElementById('passwordGroup');
const quizGroup       = document.getElementById('quizGroup');
const audioGroup = document.getElementById('audioGroup');

/* ---------- QUIZ BUILDER ---------- */
const quizBuilder = document.getElementById('quizBuilder');
document.getElementById('addQ').onclick = () => addQuestion();

function addQuestion(data = {}) {                    // data = {question,imgURL,options,answer}
  if (quizBuilder.children.length >= 10) {
    return alert('Максимум 10 вопросов');
  }
  const idx = Date.now();                            // уникальный ID для радиокнопок
  quizBuilder.insertAdjacentHTML('beforeend', `
    <div class="q-block" data-id="${idx}">
      <button class="del" onclick="this.parentNode.remove()">×</button>
      <h5>Вопрос ${quizBuilder.children.length + 1}</h5>

      <input type="file" accept="image/*" ${data.imgURL ? 'data-hasimg="' + data.imgURL + '"' : ''}><br>
      <input type="text" class="q-text" placeholder="Текст вопроса" value="${data.question || ''}">

     ${[0, 1, 2, 3].map(i => `
  <div class="opt">
    <input type="text"  class="q-opt"     placeholder="Вариант ${i + 1} (текст)">
    <input type="file"  class="q-opt-img" accept="image/*">
  </div>`).join('')}
    </div>`);
}

/* если пользователь переключил тип разблокировки — очищаем конструктор */
unlockType.addEventListener('change', () => {
  if (unlockType.value !== 'quiz') quizBuilder.innerHTML = '';
});


// 2) При клике на чекбокс «Опубликовать в Архиве»
isArchiveCh.addEventListener('change', () => {
  archiveSettings.style.display = isArchiveCh.checked ? 'block' : 'none';
});

// 3) При выборе типа разблокировки
unlockType.addEventListener('change', () => {
  passwordGroup.style.display = (unlockType.value === 'password') ? 'block' : 'none';
  quizGroup    .style.display = (unlockType.value === 'quiz')     ? 'block' : 'none';
  audioGroup   .style.display = (unlockType.value === 'audio')    ? 'block' : 'none';
  videoGroup   .style.display = (unlockType.value === 'video')    ? 'block' : 'none';
});


// 4) Скрываем настройки архива по умолчанию
archiveSettings.style.display = 'none';
passwordGroup.style.display   = 'none';
quizGroup.style.display       = 'none';


  /* ====== Обработка загрузки файла поста (uploadFile) ====== */
  async function uploadFile(file, category) {
    return new Promise((resolve, reject) => {
      const timestamp = Date.now();
      const storageRef = ref(storage, `${category}/${timestamp}_${file.name}`);
      const metadata = { contentType: file.type };

      const uploadTask = uploadBytesResumable(storageRef, file, metadata);
      const progressBar = document.querySelector('.progress');

      uploadTask.on('state_changed',
        (snapshot) => {
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          progressBar.style.width = `${progress}%`;
        },
        (error) => {
          console.error('Ошибка загрузки:', error);
          reject(error);
        },
        async () => {
          try {
            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
            resolve(downloadURL);
          } catch (err) {
            reject(err);
          }
        }
      );
    });
  }

/* ====== Предварительный просмотр файла/файлов ====== */
document.getElementById('fileInput').addEventListener('change', e => {
  const files = [...e.target.files];   // без ограничения
  const preview = document.getElementById('filePreview');
  if (!files.length) { preview.innerHTML = ''; return; }

  // если выбрали несколько фото – выводим миниатюры
  if (files[0].type.startsWith('image/')) {
    preview.innerHTML = files
      .map(f => `<img src="${URL.createObjectURL(f)}" style="width:100%;margin-bottom:8px;border-radius:8px;">`)
      .join('');
  }
  // единственный аудиофайл – оставляем прежнюю логику
  else if (files[0].type.startsWith('audio/')) {
    preview.innerHTML = `
      <audio controls style="width:100%">
        <source src="${URL.createObjectURL(files[0])}" type="${files[0].type}">
      </audio>`;
  }
});

  
// ====== Предварительный просмотр обложки (coverFile) ======
document.getElementById('coverFile').addEventListener('change', function(e) {
  const file = e.target.files[0];
  const pr = document.getElementById('coverPreview');
  if (!file || !file.type.startsWith('image/')) {
    pr.innerHTML = '';
    return;
  }
  const reader = new FileReader();
  reader.onload = ev => pr.innerHTML = `<img src="${ev.target.result}" alt="Cover">`;
  reader.readAsDataURL(file);
});


  /* ====== Предпросмотр для YouTube (videoId) ====== */
  function getYoutubeVideoId(url) {
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
  }
  document.getElementById('youtubeLink').addEventListener('input', function(e) {
    const videoId = getYoutubeVideoId(e.target.value);
    const preview = document.getElementById('youtubePreview');
    if (videoId) {
      preview.innerHTML = `
        <div class="video-preview">
          <img src="https://img.youtube.com/vi/${videoId}/maxresdefault.jpg" alt="YouTube Preview">
          <div class="play-icon">▶️</div>
        </div>`;
    } else {
      preview.innerHTML = '';
    }
  });

/* ====== Форма загрузки поста (uploadForm) ====== */
document.getElementById('uploadForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const submitBtn   = e.target.querySelector('button[type="submit"]');
  const progressBar = document.querySelector('.progress');

  try {
    submitBtn.disabled = true;
    progressBar.style.width = '10%';

    // ==== Собираем базовые поля ====
    const categoryVal    = document.getElementById('category').value;
    const descriptionVal = document.getElementById('description').value.trim();
    const taskHintVal    = document.getElementById('taskHint').value.trim();

    // ==== Архивные настройки ====
    const isArchive       = isArchiveCh.checked;
    const archiveSeq      = +document.getElementById('archiveSeq').value || null;
    const unlockTypeVal   = unlockType.value;
    const unlockPassword  = document.getElementById('unlockPassword').value.trim();
    let   unlockAudioURL  = '';
    let   unlockVideoURL  = '';
    let  unlockQuiz      = [];
    

if (isArchive && unlockTypeVal === 'quiz') {
  const quizBlocks = quizBuilder.querySelectorAll('.q-block');
  for (const block of quizBlocks) {
    // текст вопроса
    const questionText = block.querySelector('.q-text').value.trim();
    if (!questionText) continue;

    // картинка вопроса (если есть)
    const qImgFile = block.querySelector('input[type="file"]').files[0];
    let qImgURL = '';
    if (qImgFile) {
      qImgURL = await uploadFile(qImgFile, 'quiz_images');
    }

    // собираем варианты
    const opts = [];
    const textEls = block.querySelectorAll('.q-opt');
    const imgEls  = block.querySelectorAll('.q-opt-img');
    for (let i = 0; i < textEls.length; i++) {
      const text = textEls[i].value.trim();
      const file = imgEls[i].files[0];
      if (!text && !file) continue;

      let imgURL = '';
      if (file) {
        imgURL = await uploadFile(file, 'quiz_images');
      }

      opts.push({ text, imgURL });
    }
    if (opts.length === 0) continue;

    unlockQuiz.push({
      question: questionText,
      imgURL:    qImgURL,
      options:   opts
    });
  }

  if (unlockQuiz.length === 0) {
    throw new Error('Добавьте хотя бы один вопрос');
  }

  // для отладки
  document.getElementById('unlockQuiz').value = JSON.stringify(unlockQuiz);
}


    if (isArchive && unlockTypeVal === 'audio') {
      const f = document.getElementById('unlockAudio').files[0];
      if (!f) throw new Error('Загрузите аудио‑файл');
      unlockAudioURL = await uploadFile(f, 'task_audio');
    }

    if (isArchive && unlockTypeVal === 'video') {
      const vf = document.getElementById('unlockVideo').files[0];
      if (!vf) throw new Error('Загрузите видео‑файл');
      unlockVideoURL = await uploadFile(vf, 'task_video');
    }

    // ==== Формируем объект поста ====
    const newPost = {
      category:    categoryVal,
      description: descriptionVal,
      author:      auth.currentUser.email,
      timestamp:   serverTimestamp()
    };

    // ==== Основное медиа ====
    if (window.editingPostId) {
      if (window.editingFileURL) {
        newPost.fileURL = window.editingFileURL;
      }
    } else if (categoryVal === 'video') {
      const ytUrl = document.getElementById('youtubeLink').value.trim();
      if (!getYoutubeVideoId(ytUrl)) throw new Error('Неверная ссылка YouTube');
      newPost.fileURL = ytUrl;
    } else if (categoryVal === 'photo') {
      const files = [...document.getElementById('fileInput').files];
      if (!files.length) throw new Error('Добавьте фото или видео');
      const images = files.filter(f => f.type.startsWith('image/'));
      const videos = files.filter(f => f.type.startsWith('video/'));
      if (images.length) {
        newPost.photos = await Promise.all(images.map(f => uploadFile(f, 'photo')));
      }
      if (videos.length) {
        newPost.videos = await Promise.all(videos.map(f => uploadFile(f, 'uploaded_video')));
      }
    } else {
      const f = document.getElementById('fileInput').files[0];
      if (!f) throw new Error('Выберите файл');
      newPost.fileURL = await uploadFile(f, categoryVal);
    }

    progressBar.style.width = '80%';

    // ==== Музыка: дата и обложка ====
    const trackDateVal = document.getElementById('trackDate').value;
    if (trackDateVal) {
      newPost.trackDate = trackDateVal;
    }
    let coverURL = window.editingCoverURL || '';
    const coverFile = document.getElementById('coverFile').files[0];
    if (coverFile) coverURL = await uploadFile(coverFile, 'covers');
    if (coverURL) newPost.coverURL = coverURL;

    // ==== Архивные поля (если включён архив) ====
    if (isArchive) {
      newPost.isArchive   = true;
      newPost.archiveSeq  = archiveSeq;
      newPost.unlockType  = unlockTypeVal;
      if (unlockTypeVal === 'password') newPost.unlockPassword = unlockPassword;
      if (unlockTypeVal === 'quiz')     newPost.unlockQuiz     = unlockQuiz;
      if (taskHintVal)                  newPost.taskHint      = taskHintVal;
      if (unlockTypeVal === 'audio')    newPost.unlockAudio   = unlockAudioURL;
      if (unlockTypeVal === 'video')    newPost.unlockVideo   = unlockVideoURL;
    }

    // ==== Сохраняем в Firestore ====
    if (window.editingPostId) {
      await updateDoc(doc(db, 'posts', window.editingPostId), newPost);
      window.editingPostId = window.editingFileURL = window.editingCoverURL = '';
    } else {
      await addDoc(collection(db, 'posts'), newPost);
    }

    progressBar.style.width = '100%';
    alert('✅ Пост сохранён');
    loadPosts();
    loadStats();

    // ==== Сброс формы ====
    e.target.reset();
    filePreview.innerHTML = youtubePreview.innerHTML = quizBuilder.innerHTML = '';
    isArchiveCh.checked = false;
    archiveSettings.style.display = 'none';

  } catch (err) {
    alert(err.message);
    console.error(err);
  } finally {
    submitBtn.disabled = false;
    setTimeout(() => progressBar.style.width = '0%', 800);
  }
});



  /* ====== Загрузка постов (loadPosts) ====== */
  async function loadPosts() {
    const postsList = document.getElementById('postsList');
    try {
      const qPosts = query(collection(db, 'posts'), orderBy('timestamp', 'desc'));
      const snap = await getDocs(qPosts);
      if (snap.empty) {
        postsList.innerHTML = '<div class="post-item">Нет постов</div>';
        return;
      }
      let html = '';
      snap.docs.forEach((docItem) => {
        const post = docItem.data();
        const date = new Date(post.timestamp).toLocaleString('ru-RU');
        let mediaPreview = '';

        if (post.category === 'photo') {
          mediaPreview = `<img src="${post.fileURL}" alt="Photo" class="post-media">`;
        } else if (post.category === 'video') {
          const vid = getYoutubeVideoId(post.fileURL) || '';
          mediaPreview = `
            <div class="video-preview" style="position:relative;padding-bottom:56.25%;height:0;">
              <iframe 
                src="https://www.youtube.com/embed/${vid}" 
                frameborder="0"
                style="position:absolute;width:100%;height:100%;left:0;top:0;"
                allowfullscreen>
              </iframe>
            </div>`;
        } else if (post.category === 'music') {
          mediaPreview = `
            <audio controls class="post-media">
              <source src="${post.fileURL}" type="audio/mpeg">
            </audio>`;
        }

        html += `
        <div class="post-item">
          <div class="post-header">
            <div class="post-info">
              <span class="post-category">${post.category}</span>
              <span class="post-date">${date}</span>
            </div>
             <button class="delete-btn" onclick="deletePost('${docItem.id}')">Удалить</button>
      <button class="tab-button" onclick="editPost('${docItem.id}')">Редактировать</button>
          </div>
          <div class="post-content">
            ${mediaPreview}
            <p class="post-description">${post.description || ''}</p>
          </div>
        </div>`;
      });
      postsList.innerHTML = html;
    } catch (err) {
      console.error('Ошибка загрузки постов:', err);
      postsList.innerHTML = '<div class="post-item">Ошибка загрузки постов</div>';
    }
  }

  /* ====== Удаление поста (deletePost) ====== */
  window.deletePost = async function(postId) {
    if (!confirm('Вы уверены, что хотите удалить этот пост?')) return;
    try {
      await deleteDoc(doc(db, 'posts', postId));
      alert('Пост удалён!');
      loadPosts();
      loadStats(); // обновим статистику
    } catch (err) {
      console.error('Ошибка удаления поста:', err);
      alert('Ошибка удаления поста: ' + err.message);
    }
  };

  /* ====== Загрузка и обновление профиля (loadProfile, profileForm) ====== */
  async function loadProfile() {
    try {
      const profileDoc = await getDoc(doc(db, 'profiles', '5794174511'));
      if (profileDoc.exists()) {
        const data = profileDoc.data();
        document.getElementById('currentProfileName').textContent = data.first_name || 'whylovly';
        document.getElementById('currentProfileBio').textContent = data.bio || '';
        document.getElementById('profileName').value = data.first_name || 'whylovly';
        document.getElementById('profileBio').value = data.bio || '';
        if (data.photo_url) {
          document.getElementById('currentProfilePhoto').src = data.photo_url;
          document.getElementById('currentProfilePhotoPreview').src = data.photo_url;
        }
        // Загрузка соц.сетей
        if (data.social) {
          Object.entries(data.social).forEach(([net, url]) => {
            const inp = document.querySelector(`#socialLinks input[name="${net}"]`);
            if (inp) inp.value = url;
          });
        }
      }
    } catch (err) {
      console.error('Ошибка загрузки профиля:', err);
    }
  }

  document.getElementById('profileForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    try {
      const photoFile = document.getElementById('profilePhoto').files[0];
      const profileName = document.getElementById('profileName').value.trim();
      const profileBio = document.getElementById('profileBio').value.trim();
      let photoURL = '';

      if (photoFile && photoFile.type.startsWith('image/')) {
        photoURL = await uploadFile(photoFile, 'profile');
      }

      const social = {};
      document.querySelectorAll('#socialLinks input').forEach(inp => {
        if (inp.value) social[inp.name] = inp.value;
      });

      const newProfile = {
        first_name: profileName,
        bio: profileBio,
        social,
        updatedAt: new Date().toISOString()
      };
      if (photoURL) {
        newProfile.photo_url = photoURL;
      }

      await setDoc(doc(db, 'profiles', '5794174511'), newProfile, { merge: true });

      // Обновляем хедер
      document.getElementById('currentProfileName').textContent = profileName;
      document.getElementById('currentProfileBio').textContent = profileBio;
      if (photoURL) document.getElementById('currentProfilePhoto').src = photoURL;

      alert('Профиль обновлен!');
    } catch (err) {
      console.error('Ошибка обновления профиля:', err);
      alert(`Ошибка: ${err.message}`);
    }
  });

  /* ====== Загрузка и сохранение настроек (loadSettings, settingsForm) ====== */
  async function loadSettings() {
    try {
      const docSnap = await getDoc(doc(db, 'settings', 'main'));
      if (docSnap.exists()) {
        const data = docSnap.data();
        document.getElementById('siteTitle').value = data.title || '';
        document.getElementById('accentColor').value = data.accentColor || '#00ffcc';
        document.getElementById('welcomeText').value = data.welcomeText || '';
        if (data.headerImageUrl) {
          document.getElementById('headerPreview').innerHTML =
            `<img src="${data.headerImageUrl}" alt="Header Preview">`;
        }
      }
    } catch (err) {
      console.error('Ошибка загрузки настроек:', err);
    }
  }
  document.getElementById('settingsForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    try {
      const headerImage = document.getElementById('headerImage').files[0];
      let headerImageUrl = '';
      if (headerImage && headerImage.type.startsWith('image/')) {
        headerImageUrl = await uploadFile(headerImage, 'settings');
      }

      const settingsData = {
        title: document.getElementById('siteTitle').value.trim(),
        accentColor: document.getElementById('accentColor').value.trim(),
        welcomeText: document.getElementById('welcomeText').value.trim(),
        updatedAt: new Date().toISOString()
      };
      if (headerImageUrl) {
        settingsData.headerImageUrl = headerImageUrl;
      }

      await setDoc(doc(db, 'settings', 'main'), settingsData, { merge: true });
      alert('Настройки сохранены!');
    } catch (err) {
      console.error('Ошибка сохранения настроек:', err);
      alert(`Ошибка: ${err.message}`);
    }
  });

  /* ====== Загрузка статистики (loadStats) ====== */
  async function loadStats() {
    try {
      const [postsSnap, likesSnap, commentsSnap, visitsSnap] = await Promise.all([
        getDocs(collection(db, 'posts')),
        getDocs(collection(db, 'likes')),
        getDocs(collection(db, 'comments')),
        getDocs(collection(db, 'visitors'))
      ]);
      document.getElementById('totalPosts').textContent = postsSnap.size;
      document.getElementById('totalLikes').textContent = likesSnap.size;
      document.getElementById('totalComments').textContent = commentsSnap.size;
      document.getElementById('totalVisitors').textContent = visitsSnap.size;

      // Детальная статистика постов
      const postsMap = new Map();
      postsSnap.docs.forEach(d => {
        const pData = d.data();
        postsMap.set(d.id, {
          ...pData,
          id: d.id,
          timestamp: pData.timestamp || new Date().toISOString(),
          likes: [],
          comments: []
        });
      });
      likesSnap.docs.forEach(l => {
        const likeData = l.data();
        if (postsMap.has(likeData.postId)) {
          postsMap.get(likeData.postId).likes.push(likeData);
        }
      });
      commentsSnap.docs.forEach(c => {
        const comData = c.data();
        if (postsMap.has(comData.postId)) {
          postsMap.get(comData.postId).comments.push(comData);
        }
      });

      const detailedBlock = document.getElementById('detailedPostStats');
      let html = '';
      postsMap.forEach(post => {
        const dateObj = new Date(post.timestamp);
        const dateStr = dateObj.toLocaleString('ru-RU');
        html += `
          <div class="post-stat-item">
            <div class="post-stat-header">
              <div class="post-title">${post.description ? (post.description.slice(0, 50) + '...') : 'Без описания'}</div>
              <div class="post-date">${dateStr}</div>
            </div>
            <div class="post-stat-details">
              <div>Лайков: ${post.likes.length}</div>
              <div>Комментариев: ${post.comments.length}</div>
              ${
                post.likes.length > 0
                  ? `<div class="likes-details">
                       <small>Последние лайки:</small>
                       ${post.likes.slice(0, 3).map(l => {
                         const ts = (l.timestamp?.toDate?.() || new Date()).toLocaleString('ru-RU');
                         return `<div>${l.userEmail || 'Гость'} - ${ts}</div>`;
                       }).join('')}
                     </div>`
                  : ''
              }
            </div>
          </div>`;
      });
      detailedBlock.innerHTML = html;
      loadActivityData('likes'); // Активность по умолчанию
    } catch (err) {
      console.error('Ошибка загрузки статистики:', err);
    }
  }

  /* ====== Переключение вкладок активности (showActivityTab) ====== */
  window.showActivityTab = function(tab) {
    document.querySelectorAll('.activity-tab').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`[onclick="showActivityTab('${tab}')"]`).classList.add('active');
    loadActivityData(tab);
  };

// Загружает статистику квестов и заполняет таблицу #questStatsTable
async function loadQuestStats() {
  const statsTable = document.getElementById('questStatsTable').querySelector('tbody');
  statsTable.innerHTML = '<tr><td colspan="3">Загрузка...</td></tr>';

  try {
    const [progressSnap, usersSnap] = await Promise.all([
      getDocs(collection(db, 'userProgress')),
      getDocs(collection(db, 'userProfiles'))
    ]);

    // Создаём мапу: userId -> имя пользователя
    const userMap = {};
    usersSnap.forEach(doc => {
      const data = doc.data();
      userMap[doc.id] = data.displayName || data.username || data.first_name || doc.id;
    });

    // Собираем данные из userProgress
    const dataRows = [];
    progressSnap.forEach(doc => {
      const data = doc.data();
      const id = doc.id;
      dataRows.push({
        id,
        name: userMap[id] || id,
        level: data.maxLevel || '-',
        date: data.lastUpdate?.toDate().toLocaleString('ru-RU') || '-'
      });
    });

    // Сортируем по убыванию уровня
    dataRows.sort((a, b) => {
      const aLvl = (typeof a.level === 'number') ? a.level : 0;
      const bLvl = (typeof b.level === 'number') ? b.level : 0;
      return bLvl - aLvl;
    });

    // Заполняем таблицу
    statsTable.innerHTML = dataRows.map(user => `
      <tr>
        <td style="padding:8px;">${user.name}</td>
        <td style="padding:8px;">${user.level}</td>
        <td style="padding:8px;">${user.date}</td>
      </tr>
    `).join('');
  } catch (err) {
    console.error("Ошибка загрузки статистики квестов:", err);
    statsTable.innerHTML = '<tr><td colspan="3" style="color:red">Ошибка загрузки</td></tr>';
  }
}




  /* ====== Загрузка активности (лайки, комменты, посещения) ====== */
  async function loadActivityData(tab) {
    const userActivity = document.getElementById('userActivity');
    try {
      let snap;
      switch (tab) {
        case 'likes':
          snap = await getDocs(query(collection(db, 'likes'), orderBy('timestamp', 'desc')));
          break;
        case 'comments':
          snap = await getDocs(query(collection(db, 'comments'), orderBy('timestamp', 'desc')));
          break;
        case 'visits':
          snap = await getDocs(query(collection(db, 'visitors'), orderBy('timestamp', 'desc')));
          break;
      }
      if (!snap || snap.empty) {
        userActivity.innerHTML = `<p>Нет данных</p>`;
        return;
      }
      let html = '';
      snap.docs.forEach(docItem => {
        const data = docItem.data();
        const ts = data.timestamp?.toDate?.() || new Date(data.timestamp || Date.now());
        const dateStr = ts.toLocaleString('ru-RU');
        html += `
          <div class="user-activity-item">
            <img src="${data.userPhoto || '/default-avatar.png'}" alt="User" class="user-photo">
            <div class="activity-info">
              <div class="user-email">${data.displayName || data.username || data.userEmail || 'Гость'}</div>
              <div class="activity-date">${dateStr}</div>
              ${
                tab === 'comments'
                  ? `<div class="comment-text">${data.text || ''}</div>
                     <button class="delete-btn" onclick="deleteComment('${docItem.id}', '${data.postId || ''}')">Удалить</button>`
                  : ''
              }
            </div>
          </div>`;
      });
      userActivity.innerHTML = html;
    } catch (err) {
      console.error('Ошибка загрузки активности:', err);
      userActivity.innerHTML = '<p>Ошибка загрузки данных</p>';
    }
  }

  /* ====== Удаление комментария (deleteComment) ====== */
  window.deleteComment = async function(commentId, postId) {
    if (!confirm('Удалить этот комментарий?')) return;
    try {
      const batch = writeBatch(db);
      batch.delete(doc(db, 'comments', commentId));

      if (postId) {
        const postRef = doc(db, 'posts', postId);
        const postSnap = await getDoc(postRef);
        if (postSnap.exists()) {
          const currentCount = postSnap.data().commentsCount || 0;
          batch.update(postRef, { commentsCount: Math.max(0, currentCount - 1) });
        }
      }
      await batch.commit();
      loadActivityData('comments');
      loadStats();
      alert('Комментарий успешно удалён');
    } catch (err) {
      console.error('Ошибка удаления комментария:', err);
      alert('Ошибка удаления комментария');
    }
  };
// ==== Функция редактирования ====
window.editPost = async function(postId) {
  const docSnap = await getDoc(doc(db, 'posts', postId));
  if (!docSnap.exists()) return alert('Пост не найден');
  const data = docSnap.data();

  showTab('posts');
  document.getElementById('category').value = data.category;
  document.getElementById('category').dispatchEvent(new Event('change'));

  // 1) сохраняем в глобальную переменную старые URLы
  window.editingFileURL  = data.fileURL || '';
  window.editingCoverURL = data.coverURL || '';

  // 2) прячем выбор основного файла
  document.getElementById('fileInputGroup').style.display     = 'none';
  document.getElementById('youtubeLinkGroup').style.display   = 'none';

  // 3) заполняем описание и мета-данные
  document.getElementById('description').value = data.description || '';
  document.getElementById('trackDate').value   = data.trackDate   || '';
document.getElementById('taskHint').value = data.taskHint || '';

// — проставляем архивные поля —
isArchiveCh.checked = data.isArchive || false;
isArchiveCh.dispatchEvent(new Event('change'));

if (data.archiveSeq)     document.getElementById('archiveSeq').value     = data.archiveSeq;
if (data.unlockType)     unlockType.value                              = data.unlockType;
unlockType.dispatchEvent(new Event('change'));

if (data.unlockPassword) document.getElementById('unlockPassword').value = data.unlockPassword;
if (data.unlockQuiz)     document.getElementById('unlockQuiz').value     = JSON.stringify(data.unlockQuiz, null, 2);


  // 4) если есть обложка — показываем preview
  if (window.editingCoverURL) {
    document.getElementById('coverPreview').innerHTML =
      `<img src="${window.editingCoverURL}" alt="Cover">`;
  }
/* загружаем вопросы в конструктор, если они есть */
if (data.unlockQuiz?.length) {
  quizBuilder.innerHTML = '';          // очищаем
  data.unlockQuiz.forEach(addQuestion);// рисуем блоки
  unlockType.value = 'quiz';
  unlockType.dispatchEvent(new Event('change'));
}

  window.editingPostId = postId;
};


  /* ====== При загрузке страницы (DOM готов) ====== */
  document.addEventListener('DOMContentLoaded', () => {
    // Здесь можно вызвать начальные загрузки: loadPosts(), loadSettings(), etc.
    // Но они будут вызываться только после авторизации (в onAuthStateChanged)
  });
</script>
