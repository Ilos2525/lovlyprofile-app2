<!DOCTYPE html>
<html lang="ru">
<head>
  <!-- –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π CSP -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self' https://*.firebaseapp.com https://*.googleapis.com https://www.gstatic.com https://apis.google.com https://ritrag.com data: blob:;
  script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.firebaseapp.com https://*.googleapis.com https://www.gstatic.com https://apis.google.com https://ritrag.com;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
  font-src 'self' https://fonts.gstatic.com;
  img-src 'self' data: https://* blob:;
  connect-src 'self' https://*.firebaseio.com https://*.googleapis.com https://accounts.google.com https://ritrag.com wss://*.firebaseio.com;
">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å | whylovly</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --neon-color: #00ffcc;
      --bg-dark: #121212;
      --bg-card: rgba(0, 0, 0, 0.3);
      --text-color: #ffffff;
      --error-color: #ff4444;
    }

    body.light-mode {
      --bg-dark: #f5f5f5;
      --bg-card: rgba(255, 255, 255, 0.8);
      --text-color: #121212;
      color-scheme: light;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: var(--bg-dark);
      color: var(--text-color);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      color-scheme: dark;
    }

    /* –°–¢–ò–õ–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê - –ö–û–ü–ò–†–£–ï–ú –ò–ó –ü–ï–†–í–û–ì–û –ö–û–î–ê */
    .admin-header {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 20px;
      background: var(--bg-card);
      border-radius: 15px;
      border: 1px solid var(--neon-color);
      margin-bottom: 30px;
    }
    .profile-photo {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--neon-color);
    }
    .profile-info h2 {
      margin: 0;
      color: var(--neon-color);
    }
    .profile-info p {
      margin: 5px 0;
      opacity: 0.8;
    }
    .admin-tabs {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    .tab-button {
      background: var(--bg-card);
      border: 1px solid var(--neon-color);
      color: var(--text-color);
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      min-width: 150px;
    }
    .tab-button:hover {
      background: rgba(0, 255, 204, 0.1);
      transform: translateY(-2px);
    }
    .tab-button.active {
      background: var(--neon-color);
      color: var(--bg-dark);
    }
    .theme-toggle {
      margin-left: auto;
      background: transparent;
      border: 1px solid var(--neon-color);
      color: var(--neon-color);
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .theme-toggle:hover {
      background: var(--neon-color);
      color: var(--bg-dark);
    }
    .form-group {
      background: var(--bg-card);
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid var(--neon-color);
      box-shadow: 0 0 20px rgba(0, 255, 204, 0.1);
    }
    .preview-container {
      margin: 15px 0;
      max-width: 300px;
      border-radius: 8px;
      overflow: hidden;
    }
    .preview-container img {
      width: 100%;
      height: auto;
      border-radius: 8px;
    }
    .preview-container audio {
      width: 100%;
      margin: 10px 0;
    }
    .video-preview {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
    }
    .video-preview img {
      position: absolute;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .video-preview .play-icon {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 48px;
      color: white;
      text-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    h3 {
      color: var(--neon-color);
      margin-top: 0;
      font-size: 1.5em;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin: 15px 0 8px;
      color: var(--text-color);
      font-weight: 500;
    }
    select, input, textarea {
      width: 100%;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--neon-color);
      color: var(--text-color);
      border-radius: 8px;
      font-family: inherit;
      transition: all 0.3s ease;
    }
    select:focus, input:focus, textarea:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(0, 255, 204, 0.3);
    }
    button {
      background: var(--neon-color);
      color: var(--bg-dark);
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .progress-bar {
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      margin: 20px 0;
      border-radius: 3px;
      overflow: hidden;
    }
    .progress {
      height: 100%;
      background: var(--neon-color);
      width: 0%;
      transition: width 0.3s ease;
    }
    #loginForm {
      text-align: center;
      max-width: 400px;
      margin: 50px auto;
      padding: 30px;
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--neon-color);
      box-shadow: 0 0 30px rgba(0, 255, 204, 0.2);
    }
    .post-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .post-item {
      background: var(--bg-card);
      border: 1px solid var(--neon-color);
      border-radius: 12px;
      overflow: hidden;
      transition: transform 0.3s ease;
    }
    .post-item:hover {
      transform: translateY(-5px);
    }
    .post-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid rgba(0, 255, 204, 0.2);
    }
    .post-content {
      padding: 15px;
    }
    .post-media {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }
    .delete-btn {
      background: var(--error-color);
      padding: 8px 16px;
      width: auto;
      margin: 0;
      color: white;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      .admin-tabs {
        flex-direction: column;
      }
      .tab-button {
        width: 100%;
      }
    }
    .stats-block {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .stat-item {
      background: var(--bg-card);
      border: 1px solid var(--neon-color);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    .stat-number {
      font-size: 2.5em;
      color: var(--neon-color);
      margin: 10px 0;
    }
    .stat-item h4 {
      margin: 0;
      color: var(--text-color);
      opacity: 0.8;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .comments-list {
      margin-top: 20px;
    }
    .comment-item {
      background: var(--bg-card);
      border: 1px solid var(--neon-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .comment-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .comment-author {
      color: var(--neon-color);
      font-weight: 500;
    }
    .comment-date {
      opacity: 0.7;
    }
    .comment-text {
      margin: 0;
    }
    .detailed-stats {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    .post-stats {
      background: var(--bg-card);
      border: 1px solid var(--neon-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .visitor-item {
      background: var(--bg-card);
      border: 1px solid var(--neon-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .visitor-photo {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    .visitor-info {
      flex-grow: 1;
    }
    .visitor-email {
      color: var(--neon-color);
      font-weight: 500;
    }
    .visitor-date {
      opacity: 0.7;
      font-size: 0.9em;
    }
    .activity-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .activity-tab {
      background: var(--bg-card);
      border: 1px solid var(--neon-color);
      color: var(--text-color);
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }
    .activity-tab.active {
      background: var(--neon-color);
      color: var(--bg-dark);
    }
    .post-stat-item {
      background: var(--bg-card);
      border: 1px solid var(--neon-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .post-stat-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .post-stat-details {
      margin-top: 10px;
    }
    .user-activity-item {
      background: var(--bg-card);
      border: 1px solid var(--neon-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .user-photo {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    .activity-info {
      flex-grow: 1;
    }
    .activity-date {
      color: var(--neon-color);
      font-size: 0.9em;
    }
/* ==== QUIZ BUILDER ==== */
.q-block{
  border:1px solid var(--neon-color);
  border-radius:8px;padding:15px;margin-bottom:15px;
  position:relative
}
.q-block h5{margin:0 0 10px;font-weight:500;color:var(--neon-color)}
.q-block .del{
  position:absolute;top:8px;right:8px;
  background:transparent;border:none;color:#ff5555;font-size:18px;cursor:pointer
}
.q-block input[type="file"]{margin-bottom:10px}
.q-block .opt{display:flex;gap:6px;margin:4px 0}
.q-block .opt input[type="radio"]{margin-top:6px}

/* ===== –ß–∞—Ç —Å –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º–∏ ===== */
#chatThreads {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 20px;
}
#chatThreads button {
  padding: 6px 10px;
  border: 1px solid var(--neon-color);
  background: transparent;
  color: var(--neon-color);
  border-radius: 8px;
  cursor: pointer;
}
#chatBox {
  margin-top: 20px;
  max-width: 400px;
  height: 400px;
  display: none;
  flex-direction: column;
  background: var(--card-bg);
  border: 1px solid var(--neon-color);
  border-radius: var(--border-radius);
}
#chatMessages {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
}
#replyForm {
  display: flex;
  border-top: 1px solid var(--neon-color);
}
#replyInput {
  flex: 1;
  padding: 10px;
  border: none;
  background: transparent;
  color: var(--text-color);
}
#replyForm button {
  border: none;
  background: var(--neon-color);
  color: var(--bg-color);
  padding: 10px 15px;
  cursor: pointer;
}
.msg.user { text-align: left; margin-bottom: 8px; color: var(--secondary-text); }
.msg.artist { text-align: right; margin-bottom: 8px; color: var(--neon-color); }

  </style>
</head>
<body>
  <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
  <div id="loginForm">
    <h3>–í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>
    <button id="googleSignIn">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ -->
  <div id="adminContent" style="display: none;">
    <!-- –®–∞–ø–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
    <div class="admin-header">
      <img id="currentProfilePhoto" src="" alt="Profile" class="profile-photo">
      <div class="profile-info">
        <h2 id="currentProfileName">whylovly</h2>
        <p id="currentProfileBio">–ú—É–∑—ã–∫–∞–Ω—Ç | –°–æ–∑–¥–∞—Ç–µ–ª—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞ | –ê—Ä—Ç–∏—Å—Ç</p>
      </div>
      <button id="themeToggle" class="theme-toggle" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåô</button>
    </div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ç–∞–±–∞–º -->
    <div class="admin-tabs">
      <button class="tab-button active" onclick="showTab('posts')">–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç</button>
      <button class="tab-button" onclick="showTab('manage')">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞–º–∏</button>
      <button class="tab-button" onclick="showTab('stats')">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
      <button class="tab-button" onclick="showTab('profile')">–ü—Ä–æ—Ñ–∏–ª—å</button>
      <button class="tab-button" onclick="showTab('settings')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>

<!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–∫–∏ "–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç" -->
<div id="posts" class="tab-content active">
  <div class="form-group">
    <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø–æ—Å—Ç</h3>
    <form id="uploadForm">
      <label for="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
      <select id="category" required>
        <option value="photo">–§–æ—Ç–æ</option>
        <option value="music">–ú—É–∑—ã–∫–∞</option>
        <option value="video">–í–∏–¥–µ–æ (YouTube)</option>
        <option value="uploaded_video">–í–∏–¥–µ–æ (–∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ)</option>
      </select>

      <div id="fileInputGroup">
        <label for="fileInput">–§–∞–π–ª:</label>
        <input type="file" id="fileInput" accept="image/*,video/*" multiple>
        <div class="preview-container" id="filePreview"></div>
      </div>

      <div id="youtubeLinkGroup" style="display: none;">
        <label for="youtubeLink">–°—Å—ã–ª–∫–∞ –Ω–∞ YouTube:</label>
        <input type="url" id="youtubeLink" placeholder="https://youtube.com/...">
        <div class="preview-container" id="youtubePreview"></div>
      </div>

      <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
      <textarea id="description" rows="4" required></textarea>
      
 <!-- –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ music -->
<div id="musicMeta" style="display:none">
  <label for="trackDate">–î–∞—Ç–∞ —Ç—Ä–µ–∫–∞:</label>
  <input type="date" id="trackDate">

  <label for="coverFile">–û–±–ª–æ–∂–∫–∞ —Ç—Ä–µ–∫–∞:</label>
  <input type="file" id="coverFile" accept="image/*">
  <div class="preview-container" id="coverPreview"></div>
</div>

      <!-- ===== –ë–ª–æ–∫ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∞—Ä—Ö–∏–≤–∞ ===== -->
      <label style="margin-top:15px">
        <input type="checkbox" id="isArchive">
        –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ ¬´–ê—Ä—Ö–∏–≤–µ¬ª
      </label>

      <div id="archiveSettings" style="display:none; margin:10px 0 20px 20px; padding-left:10px; border-left:2px solid var(--neon-color);">
        <label for="archiveSeq">–ù–æ–º–µ—Ä –∑–∞–¥–∞–Ω–∏—è (archiveSeq):</label>
        <input type="number" id="archiveSeq" min="1" placeholder="1">

        <label for="unlockType">–¢–∏–ø —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:</label>
      <select id="unlockType">
  <option value="auto">auto (–∞–≤—Ç–æ)</option>
  <option value="password">password</option>
  <option value="quiz">quiz</option>
  <option value="final">final (–∫–Ω–æ–ø–∫–∞)</option>
  <option value="audio">audio</option>
  <option value="video">video</option>
</select>


        <div id="passwordGroup" style="display:none; margin-top:10px;">
          <label for="unlockPassword">–ü–∞—Ä–æ–ª—å:</label>
          <input type="text" id="unlockPassword" placeholder="A123">
        </div>

<div id="audioGroup" style="display:none; margin-top:10px;">
  <label for="unlockAudio">–ê—É–¥–∏–æ‚Äë—Ñ–∞–π–ª (mp3):</label>
  <!-- —Ç–µ–ø–µ—Ä—å —Ñ–∏–ª—å—Ç—Ä –ø–æ mp3 –∏ –≤—Å–µ–º –∞—É–¥–∏–æ‚Äë—Ç–∏–ø–∞–º -->
  <input type="file" id="unlockAudio" accept=".mp3,audio/*">
</div>


        <div id="videoGroup" style="display:none;margin-top:10px;">
  <label for="unlockVideo">–í–∏–¥–µ–æ‚Äë—Ñ–∞–π–ª (mp4):</label>
  <input type="file" id="unlockVideo" accept="video/*">
</div>


        <div id="quizGroup" style="display:none; margin-top:10px;">
  <h4>–í–∏–∫—Ç–æ—Ä–∏–Ω–∞ (–¥–æ¬†10¬†–≤–æ–ø—Ä–æ—Å–æ–≤)</h4>

  <div id="quizBuilder"></div>

  <button type="button" id="addQ" style="margin-top:12px">
    +¬†–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å
  </button>

  <!-- —Å—é–¥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–ª–∞–¥—ë–º –≥–æ—Ç–æ–≤—ã–π JSON -->
  <input type="hidden" id="unlockQuiz">
</div>


  <label for="taskHint">–ü–æ–¥—Å–∫–∞–∑–∫–∞ / —Ç–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è:</label>
  <textarea id="taskHint" rows="3"></textarea>
</div>
      <!-- ===== /–ë–ª–æ–∫ –∞—Ä—Ö–∏–≤–∞ ===== -->


      <div class="progress-bar">
        <div class="progress"></div>
      </div>

      <button type="submit">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
    </form>
  </div>
</div>

    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–∫–∏ "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞–º–∏" -->
    <div id="manage" class="tab-content">
      <div class="form-group">
        <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞–º–∏</h3>
        <div class="post-grid" id="postsList">
          <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</div>
        </div>
      </div>
    </div>

    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–∫–∏ "–ü—Ä–æ—Ñ–∏–ª—å" -->
    <div id="profile" class="tab-content">
      <div class="form-group">
        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h3>
        <form id="profileForm">
          <div class="profile-upload">
            <label for="profilePhoto">–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è:</label>
            <input type="file" id="profilePhoto" accept="image/*">
            <div class="preview-container" id="profilePreview">
              <img id="currentProfilePhotoPreview" src="" alt="Preview">
            </div>
          </div>

          <label for="profileName">–ò–º—è –ø—Ä–æ—Ñ–∏–ª—è:</label>
          <input type="text" id="profileName" required>

          <label for="profileBio">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è:</label>
          <textarea id="profileBio" rows="3" required></textarea>

          <label for="socialLinks">–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏:</label>
          <div id="socialLinks">
            <input type="url" placeholder="Instagram" name="instagram">
            <input type="url" placeholder="YouTube" name="youtube">
            <input type="url" placeholder="VK" name="vk">
          </div>

          <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        </form>
      </div>
    </div>

    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–∫–∏ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" -->
    <div id="settings" class="tab-content">
      <div class="form-group">
        <h3>–û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
        <form id="settingsForm">
          <label for="siteTitle">–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–∞–π—Ç–∞:</label>
          <input type="text" id="siteTitle" required>

          <label for="accentColor">–¶–≤–µ—Ç –∞–∫—Ü–µ–Ω—Ç–∞:</label>
          <input type="color" id="accentColor" value="#00ffcc">

          <label for="headerImage">–§–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —à–∞–ø–∫–∏:</label>
          <input type="file" id="headerImage" accept="image/*">
          <div class="preview-container" id="headerPreview"></div>

          <div class="form-group">
            <h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã</h4>
            <label for="welcomeText">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:</label>
            <textarea id="welcomeText" rows="3"></textarea>

            <label for="featuredContent">–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç:</label>
            <select id="featuredContent">
              <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
            </select>
          </div>

          <button type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </form>
      </div>
    </div>

    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–∫–∏ "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" -->
    <div id="stats" class="tab-content">
      <div class="form-group">
        <h3>–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
        <div class="stats-block">
          <div class="stat-item">
            <h4>–í—Å–µ–≥–æ –ø–æ—Å—Ç–æ–≤</h4>
            <div id="totalPosts" class="stat-number">0</div>
          </div>
          <div class="stat-item">
            <h4>–í—Å–µ–≥–æ –ª–∞–π–∫–æ–≤</h4>
            <div id="totalLikes" class="stat-number">0</div>
          </div>
          <div class="stat-item">
            <h4>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</h4>
            <div id="totalComments" class="stat-number">0</div>
          </div>
          <div class="stat-item">
            <h4>–ü–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π</h4>
            <div id="totalVisitors" class="stat-number">0</div>
          </div>
        </div>

          <!-- –°–µ–∫—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–π –∫–≤–µ—Å—Ç–æ–≤ -->
  <div class="form-group">
    <h3>–ö—Ç–æ –¥–æ –∫–∞–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è –¥–æ—à—ë–ª</h3>
    <table id="questStatsTable" style="width:100%; border-collapse: collapse; text-align: left;">
      <thead>
        <tr>
          <th style="border-bottom:1px solid var(--neon-color); padding:8px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
          <th style="border-bottom:1px solid var(--neon-color); padding:8px;">–ú–∞–∫—Å. —É—Ä–æ–≤–µ–Ω—å</th>
          <th style="border-bottom:1px solid var(--neon-color); padding:8px;">–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–æ—Ö–æ–¥–∞</th>
        </tr>
      </thead>
      <tbody>
        <!-- —Å—é–¥–∞ JS –ø–æ–¥—Å—Ç–∞–≤–∏—Ç —Å—Ç—Ä–æ–∫–∏ -->
      </tbody>
    </table>
  </div>


        <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ—Å—Ç–∞–º -->
        <div class="form-group">
          <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ—Å—Ç–∞–º</h3>
          <div id="detailedPostStats" class="detailed-stats">
            <!-- –°—é–¥–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –¥–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å—Ç–æ–≤ -->
          </div>
        </div>

        <!-- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div class="form-group">
          <h3>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
          <div class="activity-tabs">
            <button class="activity-tab active" onclick="showActivityTab('likes')">–õ–∞–π–∫–∏</button>
            <button class="activity-tab" onclick="showActivityTab('comments')">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</button>
            <button class="activity-tab" onclick="showActivityTab('visits')">–ü–æ—Å–µ—â–µ–Ω–∏—è</button>
          </div>
          <div id="userActivity" class="user-activity">
            <!-- –°—é–¥–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
          </div>
        </div>
      </div>
    </div>
    </div>

<section id="subscriberChat">
  <h2>–ß–∞—Ç —Å –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º–∏</h2>
  <div id="chatThreads"></div>
  <div id="chatBox">
    <div id="chatMessages"></div>
    <form id="replyForm">
      <input id="replyInput" type="text" placeholder="–û—Ç–≤–µ—Ç..." autocomplete="off" />
      <button type="submit">‚Æû</button>
    </form>
  </div>
</section>

<!-- –ë–ª–æ–∫ —Å–∫—Ä–∏–ø—Ç–æ–≤ Firebase –∏ –æ—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–∏ -->
<script type="module">
  /* ====== –ò–º–ø–æ—Ä—Ç—ã Firebase ====== */
 import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getAuth, 
  GoogleAuthProvider, 
  signInWithPopup, // –¥–æ–±–∞–≤–ª–µ–Ω–æ
  signInWithRedirect, 
  getRedirectResult, 
  onAuthStateChanged, 
  setPersistence, 
  browserLocalPersistence 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  doc,
  getDoc,
  setDoc,
  getDocs,
  addDoc,
  deleteDoc,
  query,
  where,
  orderBy,
  updateDoc,
  writeBatch,
  serverTimestamp,
  onSnapshot,
  limit
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  
  import { 
    getStorage, 
    ref, 
    uploadBytesResumable, 
    getDownloadURL 
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";


  /* ====== –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase ====== */
  const firebaseConfig = {
    apiKey: "AIzaSyDPMqef3_hF-QpBr09qtry_45K4h28oMT0",
    authDomain: "whylovly-website-8adcb.firebaseapp.com",
    projectId: "whylovly-website-8adcb",
    storageBucket: "whylovly-website-8adcb.firebasestorage.app", 
    messagingSenderId: "749833792533",
    appId: "1:749833792533:web:2494649a11b628cd84321c"
  };

  /* ====== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase ====== */
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
const storage = getStorage(app);

  const themeToggle = document.getElementById('themeToggle');
  function applyTheme(theme) {
    document.body.classList.toggle('light-mode', theme === 'light');
    themeToggle.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
    localStorage.setItem('theme', theme);
  }
  applyTheme(localStorage.getItem('theme') || 'dark');
  themeToggle.addEventListener('click', () => {
    const newTheme = document.body.classList.contains('light-mode') ? 'dark' : 'light';
    applyTheme(newTheme);
  });

  /* ====== –ß–∞—Ç —Å –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º–∏ ====== */
  const chatThreads = document.getElementById('chatThreads');
  const chatBox = document.getElementById('chatBox');
  const chatMessages = document.getElementById('chatMessages');
  const replyForm = document.getElementById('replyForm');
  const replyInput = document.getElementById('replyInput');
  let activeChatUser = null;
  let chatsData = {};

  onSnapshot(collection(db, 'chats'), (snap) => {
    chatsData = {};
    snap.forEach((docSnap) => {
      const data = docSnap.data();
      if (!chatsData[data.userId]) chatsData[data.userId] = [];
      chatsData[data.userId].push({ id: docSnap.id, ...data });
    });
    chatThreads.innerHTML = '';
    Object.keys(chatsData).forEach((uid) => {
      const btn = document.createElement('button');
      btn.textContent = uid;
      btn.onclick = () => {
        activeChatUser = uid;
        chatBox.style.display = 'flex';
        renderMessages();
      };
      chatThreads.appendChild(btn);
    });
    if (activeChatUser) renderMessages();
  });

  function renderMessages() {
    chatMessages.innerHTML = '';
    (chatsData[activeChatUser] || [])
      .sort((a, b) => a.timestamp?.toMillis() - b.timestamp?.toMillis())
      .forEach((m) => {
        const udiv = document.createElement('div');
        udiv.className = 'msg user';
        udiv.textContent = m.text;
        chatMessages.appendChild(udiv);
        if (m.reply) {
          const adiv = document.createElement('div');
          adiv.className = 'msg artist';
          adiv.textContent = m.reply;
          chatMessages.appendChild(adiv);
        }
      });
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  if (replyForm) {
    replyForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = replyInput.value.trim();
      if (!text || !activeChatUser) return;
      const q = query(
        collection(db, 'chats'),
        where('userId', '==', activeChatUser),
        orderBy('timestamp', 'desc'),
        limit(1)
      );
      const snap = await getDocs(q);
      if (!snap.empty) {
        await updateDoc(snap.docs[0].ref, { reply: text });
      }
      replyInput.value = '';
    });
  }

  /* ====== –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Å–µ—Å—Å–∏–∏ ====== */
  setPersistence(auth, browserLocalPersistence)
    .then(() => {
      console.log("Persistence set to LOCAL");
    })
    .catch((err) => {
      console.error("Error setting persistence:", err);
    });

  /* ====== –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ (signInWithRedirect) ====== */
  getRedirectResult(auth)
    .then((result) => {
      if (result && result.user) {
        console.log("–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ —Ä–µ–¥–∏—Ä–µ–∫—Ç:", result.user.email);
        if (result.user.email === 'iosinniy1@gmail.com') {
          document.getElementById('loginForm').style.display = 'none';
          document.getElementById('adminContent').style.display = 'block';
        } else {
          auth.signOut();
          alert('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω.');
        }
      }
    })
    .catch((error) => {
      console.error('–û—à–∏–±–∫–∞ –ø–æ—Å–ª–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞:', error);
    });

  /* ====== –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google" ====== */
 document.getElementById('googleSignIn').addEventListener('click', async function() {
  try {
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º signInWithPopup –≤–º–µ—Å—Ç–æ signInWithRedirect
    const result = await signInWithPopup(auth, provider);
    console.log("Popup sign-in successful:", result.user.email);

    // –ï—Å–ª–∏ email —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
    if (result.user.email === 'iosinniy1@gmail.com') {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('adminContent').style.display = 'block';
      loadProfile();
    } else {
      auth.signOut();
      alert('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω.');
    }
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:", error.code, error.message, error);
    let errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ';

    switch (error.code) {
      case 'auth/popup-blocked':
        errorMessage = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Å–∞–π—Ç–∞';
        break;
      case 'auth/popup-closed-by-user':
        errorMessage = '–í—Ö–æ–¥ –±—ã–ª –æ—Ç–º–µ–Ω–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞';
        break;
      case 'auth/cancelled-popup-request':
        errorMessage = '–ü—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—Ö–æ–¥ –µ—â—ë –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è';
        break;
      case 'auth/network-request-failed':
        errorMessage = '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É';
        break;
    }

    alert(errorMessage);
  }
});


  /* ====== –°–ª—É—à–∞—Ç–µ–ª—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ====== */
  onAuthStateChanged(auth, (user) => {
    if (user && user.email === 'iosinniy1@gmail.com') {
      console.log("–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:", user.email);
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('adminContent').style.display = 'block';
      loadProfile(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    } else {
      console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∏–ª–∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º");
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('adminContent').style.display = 'none';
    }
  });

  /* ====== –°–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫ (showTab) ====== */
  window.showTab = function(tabId) {
    document.querySelectorAll('.tab-content').forEach(section => {
      section.classList.remove('active');
    });
    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.classList.remove('active');
    });
    const targetTab = document.getElementById(tabId);
    const clickedBtn = document.querySelector(`[onclick="showTab('${tabId}')"]`);

    if (targetTab) targetTab.classList.add('active');
    if (clickedBtn) clickedBtn.classList.add('active');

     if (tabId === 'manage') loadPosts();
  if (tabId === 'stats') {
    loadStats();
    loadQuestStats();  // <-- –¥–æ–±–∞–≤–∏–ª–∏
  }
    
  };

// ====== –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∏–ø–∞ –ø–æ—Å—Ç–∞ (–∫–∞—Ç–µ–≥–æ—Ä–∏—è) ======
const categoryEl   = document.getElementById('category');
const fileInput    = document.getElementById('fileInput');
const fileGroup    = document.getElementById('fileInputGroup');
const ytGroup      = document.getElementById('youtubeLinkGroup');
const musicMeta    = document.getElementById('musicMeta');
const filePreview  = document.getElementById('filePreview');
const ytPreview    = document.getElementById('youtubePreview');

categoryEl.addEventListener('change', e => {
  const cat = e.target.value;

  // 1) –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–¥–∞—ë–º accept
  if (cat === 'uploaded_video') {
    fileInput.accept = 'video/*';
  } else if (cat === 'photo') {
    fileInput.accept = 'image/*,video/*';
  } else {
    // –¥–ª—è music –∏ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö ‚Äî —Ç–æ–ª—å–∫–æ –∫–∞—Ä—Ç–∏–Ω–∫–∏
    fileInput.accept = 'image/*';
  }

  // 2) –ü—Ä—è—á–µ—Ç/–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç fileInput vs YouTube‚Äë—Å—Å—ã–ª–∫—É
  if (cat === 'video') {
    fileGroup.style.display = 'none';
    ytGroup.style.display   = 'block';
  } else {
    ytGroup.style.display   = 'none';
    fileGroup.style.display = 'block';
  }

  // 3) –ú–µ—Ç–∞‚Äë–±–ª–æ–∫ –¥–ª—è –º—É–∑—ã–∫–∏
  musicMeta.style.display = (cat === 'music') ? 'block' : 'none';

  // 4) –°–±—Ä–æ—Å –ø—Ä–µ–≤—å—é
  filePreview.innerHTML = '';
  ytPreview.innerHTML   = '';
});



// ====== –õ–æ–≥–∏–∫–∞ –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –ø–æ–ª–µ–π –ê—Ä—Ö–∏–≤–∞ ======
// 1) –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
const isArchiveCh     = document.getElementById('isArchive');
const archiveSettings = document.getElementById('archiveSettings');
const unlockType      = document.getElementById('unlockType');
const passwordGroup   = document.getElementById('passwordGroup');
const quizGroup       = document.getElementById('quizGroup');
const audioGroup = document.getElementById('audioGroup');

/* ---------- QUIZ BUILDER ---------- */
const quizBuilder = document.getElementById('quizBuilder');
document.getElementById('addQ').onclick = () => addQuestion();

function addQuestion(data = {}) {                    // data = {question,imgURL,options,answer}
  if (quizBuilder.children.length >= 10) {
    return alert('–ú–∞–∫—Å–∏–º—É–º 10 –≤–æ–ø—Ä–æ—Å–æ–≤');
  }
  const idx = Date.now();                            // —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–æ–∫
  quizBuilder.insertAdjacentHTML('beforeend', `
    <div class="q-block" data-id="${idx}">
      <button class="del" onclick="this.parentNode.remove()">√ó</button>
      <h5>–í–æ–ø—Ä–æ—Å¬†${quizBuilder.children.length + 1}</h5>

      <input type="file" accept="image/*" ${data.imgURL ? 'data-hasimg="' + data.imgURL + '"' : ''}><br>
      <input type="text" class="q-text" placeholder="–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞" value="${data.question || ''}">

     ${[0, 1, 2, 3].map(i => `
  <div class="opt">
    <input type="text"  class="q-opt"     placeholder="–í–∞—Ä–∏–∞–Ω—Ç ${i + 1} (—Ç–µ–∫—Å—Ç)">
    <input type="file"  class="q-opt-img" accept="image/*">
  </div>`).join('')}
    </div>`);
}

/* –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–∫–ª—é—á–∏–ª —Ç–∏–ø —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ ‚Äî –æ—á–∏—â–∞–µ–º –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä */
unlockType.addEventListener('change', () => {
  if (unlockType.value !== 'quiz') quizBuilder.innerHTML = '';
});


// 2) –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —á–µ–∫–±–æ–∫—Å ¬´–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ –ê—Ä—Ö–∏–≤–µ¬ª
isArchiveCh.addEventListener('change', () => {
  archiveSettings.style.display = isArchiveCh.checked ? 'block' : 'none';
});

// 3) –ü—Ä–∏ –≤—ã–±–æ—Ä–µ —Ç–∏–ø–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
unlockType.addEventListener('change', () => {
  passwordGroup.style.display = (unlockType.value === 'password') ? 'block' : 'none';
  quizGroup    .style.display = (unlockType.value === 'quiz')     ? 'block' : 'none';
  audioGroup   .style.display = (unlockType.value === 'audio')    ? 'block' : 'none';
  videoGroup   .style.display = (unlockType.value === 'video')    ? 'block' : 'none';
});


// 4) –°–∫—Ä—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞—Ä—Ö–∏–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
archiveSettings.style.display = 'none';
passwordGroup.style.display   = 'none';
quizGroup.style.display       = 'none';


  /* ====== –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –ø–æ—Å—Ç–∞ (uploadFile) ====== */
  async function uploadFile(file, category) {
    return new Promise((resolve, reject) => {
      const timestamp = Date.now();
      const storageRef = ref(storage, `${category}/${timestamp}_${file.name}`);
      const metadata = { contentType: file.type };

      const uploadTask = uploadBytesResumable(storageRef, file, metadata);
      const progressBar = document.querySelector('.progress');

      uploadTask.on('state_changed',
        (snapshot) => {
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          progressBar.style.width = `${progress}%`;
        },
        (error) => {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
          reject(error);
        },
        async () => {
          try {
            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
            resolve(downloadURL);
          } catch (err) {
            reject(err);
          }
        }
      );
    });
  }

/* ====== –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–π–ª–∞/—Ñ–∞–π–ª–æ–≤ ====== */
document.getElementById('fileInput').addEventListener('change', e => {
  const files = [...e.target.files];   // –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
  const preview = document.getElementById('filePreview');
  if (!files.length) { preview.innerHTML = ''; return; }

  // –µ—Å–ª–∏ –≤—ã–±—Ä–∞–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ ‚Äì –≤—ã–≤–æ–¥–∏–º –º–∏–Ω–∏–∞—Ç—é—Ä—ã
  if (files[0].type.startsWith('image/')) {
    preview.innerHTML = files
      .map(f => `<img src="${URL.createObjectURL(f)}" style="width:100%;margin-bottom:8px;border-radius:8px;">`)
      .join('');
  }
  // –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∞—É–¥–∏–æ—Ñ–∞–π–ª ‚Äì –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–µ–∂–Ω—é—é –ª–æ–≥–∏–∫—É
  else if (files[0].type.startsWith('audio/')) {
    preview.innerHTML = `
      <audio controls style="width:100%">
        <source src="${URL.createObjectURL(files[0])}" type="${files[0].type}">
      </audio>`;
  }
});

  
// ====== –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –æ–±–ª–æ–∂–∫–∏ (coverFile) ======
document.getElementById('coverFile').addEventListener('change', function(e) {
  const file = e.target.files[0];
  const pr = document.getElementById('coverPreview');
  if (!file || !file.type.startsWith('image/')) {
    pr.innerHTML = '';
    return;
  }
  const reader = new FileReader();
  reader.onload = ev => pr.innerHTML = `<img src="${ev.target.result}" alt="Cover">`;
  reader.readAsDataURL(file);
});


  /* ====== –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–ª—è YouTube (videoId) ====== */
  function getYoutubeVideoId(url) {
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
  }
  document.getElementById('youtubeLink').addEventListener('input', function(e) {
    const videoId = getYoutubeVideoId(e.target.value);
    const preview = document.getElementById('youtubePreview');
    if (videoId) {
      preview.innerHTML = `
        <div class="video-preview">
          <img src="https://img.youtube.com/vi/${videoId}/maxresdefault.jpg" alt="YouTube Preview">
          <div class="play-icon">‚ñ∂Ô∏è</div>
        </div>`;
    } else {
      preview.innerHTML = '';
    }
  });

/* ====== –§–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–∞ (uploadForm) ====== */
document.getElementById('uploadForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const submitBtn   = e.target.querySelector('button[type="submit"]');
  const progressBar = document.querySelector('.progress');

  try {
    submitBtn.disabled = true;
    progressBar.style.width = '10%';

    // ==== –°–æ–±–∏—Ä–∞–µ–º –±–∞–∑–æ–≤—ã–µ –ø–æ–ª—è ====
    const categoryVal    = document.getElementById('category').value;
    const descriptionVal = document.getElementById('description').value.trim();
    const taskHintVal    = document.getElementById('taskHint').value.trim();

    // ==== –ê—Ä—Ö–∏–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ====
    const isArchive       = isArchiveCh.checked;
    const archiveSeq      = +document.getElementById('archiveSeq').value || null;
    const unlockTypeVal   = unlockType.value;
    const unlockPassword  = document.getElementById('unlockPassword').value.trim();
    let   unlockAudioURL  = '';
    let   unlockVideoURL  = '';
    let  unlockQuiz      = [];
    

if (isArchive && unlockTypeVal === 'quiz') {
  const quizBlocks = quizBuilder.querySelectorAll('.q-block');
  for (const block of quizBlocks) {
    // —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞
    const questionText = block.querySelector('.q-text').value.trim();
    if (!questionText) continue;

    // –∫–∞—Ä—Ç–∏–Ω–∫–∞ –≤–æ–ø—Ä–æ—Å–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    const qImgFile = block.querySelector('input[type="file"]').files[0];
    let qImgURL = '';
    if (qImgFile) {
      qImgURL = await uploadFile(qImgFile, 'quiz_images');
    }

    // —Å–æ–±–∏—Ä–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã
    const opts = [];
    const textEls = block.querySelectorAll('.q-opt');
    const imgEls  = block.querySelectorAll('.q-opt-img');
    for (let i = 0; i < textEls.length; i++) {
      const text = textEls[i].value.trim();
      const file = imgEls[i].files[0];
      if (!text && !file) continue;

      let imgURL = '';
      if (file) {
        imgURL = await uploadFile(file, 'quiz_images');
      }

      opts.push({ text, imgURL });
    }
    if (opts.length === 0) continue;

    unlockQuiz.push({
      question: questionText,
      imgURL:    qImgURL,
      options:   opts
    });
  }

  if (unlockQuiz.length === 0) {
    throw new Error('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å');
  }

  // –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
  document.getElementById('unlockQuiz').value = JSON.stringify(unlockQuiz);
}


    if (isArchive && unlockTypeVal === 'audio') {
      const f = document.getElementById('unlockAudio').files[0];
      if (!f) throw new Error('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞—É–¥–∏–æ‚Äë—Ñ–∞–π–ª');
      unlockAudioURL = await uploadFile(f, 'task_audio');
    }

    if (isArchive && unlockTypeVal === 'video') {
      const vf = document.getElementById('unlockVideo').files[0];
      if (!vf) throw new Error('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ‚Äë—Ñ–∞–π–ª');
      unlockVideoURL = await uploadFile(vf, 'task_video');
    }

    // ==== –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç –ø–æ—Å—Ç–∞ ====
    const newPost = {
      category:    categoryVal,
      description: descriptionVal,
      author:      auth.currentUser.email,
      timestamp:   serverTimestamp()
    };

    // ==== –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–¥–∏–∞ ====
    if (window.editingPostId) {
      if (window.editingFileURL) {
        newPost.fileURL = window.editingFileURL;
      }
    } else if (categoryVal === 'video') {
      const ytUrl = document.getElementById('youtubeLink').value.trim();
      if (!getYoutubeVideoId(ytUrl)) throw new Error('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Å—ã–ª–∫–∞ YouTube');
      newPost.fileURL = ytUrl;
    } else if (categoryVal === 'photo') {
      const files = [...document.getElementById('fileInput').files];
      if (!files.length) throw new Error('–î–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ');
      const images = files.filter(f => f.type.startsWith('image/'));
      const videos = files.filter(f => f.type.startsWith('video/'));
      if (images.length) {
        newPost.photos = await Promise.all(images.map(f => uploadFile(f, 'photo')));
      }
      if (videos.length) {
        newPost.videos = await Promise.all(videos.map(f => uploadFile(f, 'uploaded_video')));
      }
    } else {
      const f = document.getElementById('fileInput').files[0];
      if (!f) throw new Error('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
      newPost.fileURL = await uploadFile(f, categoryVal);
    }

    progressBar.style.width = '80%';

    // ==== –ú—É–∑—ã–∫–∞: –¥–∞—Ç–∞ –∏ –æ–±–ª–æ–∂–∫–∞ ====
    const trackDateVal = document.getElementById('trackDate').value;
    if (trackDateVal) {
      newPost.trackDate = trackDateVal;
    }
    let coverURL = window.editingCoverURL || '';
    const coverFile = document.getElementById('coverFile').files[0];
    if (coverFile) coverURL = await uploadFile(coverFile, 'covers');
    if (coverURL) newPost.coverURL = coverURL;

    // ==== –ê—Ä—Ö–∏–≤–Ω—ã–µ –ø–æ–ª—è (–µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω –∞—Ä—Ö–∏–≤) ====
    if (isArchive) {
      newPost.isArchive   = true;
      newPost.archiveSeq  = archiveSeq;
      newPost.unlockType  = unlockTypeVal;
      if (unlockTypeVal === 'password') newPost.unlockPassword = unlockPassword;
      if (unlockTypeVal === 'quiz')     newPost.unlockQuiz     = unlockQuiz;
      if (taskHintVal)                  newPost.taskHint      = taskHintVal;
      if (unlockTypeVal === 'audio')    newPost.unlockAudio   = unlockAudioURL;
      if (unlockTypeVal === 'video')    newPost.unlockVideo   = unlockVideoURL;
    }

    // ==== –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firestore ====
    if (window.editingPostId) {
      await updateDoc(doc(db, 'posts', window.editingPostId), newPost);
      window.editingPostId = window.editingFileURL = window.editingCoverURL = '';
    } else {
      await addDoc(collection(db, 'posts'), newPost);
    }

    progressBar.style.width = '100%';
    alert('‚úÖ –ü–æ—Å—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
    loadPosts();
    loadStats();

    // ==== –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã ====
    e.target.reset();
    filePreview.innerHTML = youtubePreview.innerHTML = quizBuilder.innerHTML = '';
    isArchiveCh.checked = false;
    archiveSettings.style.display = 'none';

  } catch (err) {
    alert(err.message);
    console.error(err);
  } finally {
    submitBtn.disabled = false;
    setTimeout(() => progressBar.style.width = '0%', 800);
  }
});



  /* ====== –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤ (loadPosts) ====== */
  async function loadPosts() {
    const postsList = document.getElementById('postsList');
    try {
      const qPosts = query(collection(db, 'posts'), orderBy('timestamp', 'desc'));
      const snap = await getDocs(qPosts);
      if (snap.empty) {
        postsList.innerHTML = '<div class="post-item">–ù–µ—Ç –ø–æ—Å—Ç–æ–≤</div>';
        return;
      }
      let html = '';
      snap.docs.forEach((docItem) => {
        const post = docItem.data();
        const date = new Date(post.timestamp).toLocaleString('ru-RU');
        let mediaPreview = '';

        if (post.category === 'photo') {
          mediaPreview = `<img src="${post.fileURL}" alt="Photo" class="post-media">`;
        } else if (post.category === 'video') {
          const vid = getYoutubeVideoId(post.fileURL) || '';
          mediaPreview = `
            <div class="video-preview" style="position:relative;padding-bottom:56.25%;height:0;">
              <iframe 
                src="https://www.youtube.com/embed/${vid}" 
                frameborder="0"
                style="position:absolute;width:100%;height:100%;left:0;top:0;"
                allowfullscreen>
              </iframe>
            </div>`;
        } else if (post.category === 'music') {
          mediaPreview = `
            <audio controls class="post-media">
              <source src="${post.fileURL}" type="audio/mpeg">
            </audio>`;
        }

        html += `
        <div class="post-item">
          <div class="post-header">
            <div class="post-info">
              <span class="post-category">${post.category}</span>
              <span class="post-date">${date}</span>
            </div>
             <button class="delete-btn" onclick="deletePost('${docItem.id}')">–£–¥–∞–ª–∏—Ç—å</button>
      <button class="tab-button" onclick="editPost('${docItem.id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
          <div class="post-content">
            ${mediaPreview}
            <p class="post-description">${post.description || ''}</p>
          </div>
        </div>`;
      });
      postsList.innerHTML = html;
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤:', err);
      postsList.innerHTML = '<div class="post-item">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤</div>';
    }
  }

  /* ====== –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞ (deletePost) ====== */
  window.deletePost = async function(postId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?')) return;
    try {
      await deleteDoc(doc(db, 'posts', postId));
      alert('–ü–æ—Å—Ç —É–¥–∞–ª—ë–Ω!');
      loadPosts();
      loadStats(); // –æ–±–Ω–æ–≤–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞:', err);
      alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞: ' + err.message);
    }
  };

  /* ====== –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è (loadProfile, profileForm) ====== */
  async function loadProfile() {
    try {
      const profileDoc = await getDoc(doc(db, 'profiles', '5794174511'));
      if (profileDoc.exists()) {
        const data = profileDoc.data();
        document.getElementById('currentProfileName').textContent = data.first_name || 'whylovly';
        document.getElementById('currentProfileBio').textContent = data.bio || '';
        document.getElementById('profileName').value = data.first_name || 'whylovly';
        document.getElementById('profileBio').value = data.bio || '';
        if (data.photo_url) {
          document.getElementById('currentProfilePhoto').src = data.photo_url;
          document.getElementById('currentProfilePhotoPreview').src = data.photo_url;
        }
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ü.—Å–µ—Ç–µ–π
        if (data.social) {
          Object.entries(data.social).forEach(([net, url]) => {
            const inp = document.querySelector(`#socialLinks input[name="${net}"]`);
            if (inp) inp.value = url;
          });
        }
      }
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', err);
    }
  }

  document.getElementById('profileForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    try {
      const photoFile = document.getElementById('profilePhoto').files[0];
      const profileName = document.getElementById('profileName').value.trim();
      const profileBio = document.getElementById('profileBio').value.trim();
      let photoURL = '';

      if (photoFile && photoFile.type.startsWith('image/')) {
        photoURL = await uploadFile(photoFile, 'profile');
      }

      const social = {};
      document.querySelectorAll('#socialLinks input').forEach(inp => {
        if (inp.value) social[inp.name] = inp.value;
      });

      const newProfile = {
        first_name: profileName,
        bio: profileBio,
        social,
        updatedAt: new Date().toISOString()
      };
      if (photoURL) {
        newProfile.photo_url = photoURL;
      }

      await setDoc(doc(db, 'profiles', '5794174511'), newProfile, { merge: true });

      // –û–±–Ω–æ–≤–ª—è–µ–º —Ö–µ–¥–µ—Ä
      document.getElementById('currentProfileName').textContent = profileName;
      document.getElementById('currentProfileBio').textContent = profileBio;
      if (photoURL) document.getElementById('currentProfilePhoto').src = photoURL;

      alert('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!');
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', err);
      alert(`–û—à–∏–±–∫–∞: ${err.message}`);
    }
  });

  /* ====== –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (loadSettings, settingsForm) ====== */
  async function loadSettings() {
    try {
      const docSnap = await getDoc(doc(db, 'settings', 'main'));
      if (docSnap.exists()) {
        const data = docSnap.data();
        document.getElementById('siteTitle').value = data.title || '';
        document.getElementById('accentColor').value = data.accentColor || '#00ffcc';
        document.getElementById('welcomeText').value = data.welcomeText || '';
        if (data.headerImageUrl) {
          document.getElementById('headerPreview').innerHTML =
            `<img src="${data.headerImageUrl}" alt="Header Preview">`;
        }
      }
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', err);
    }
  }
  document.getElementById('settingsForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    try {
      const headerImage = document.getElementById('headerImage').files[0];
      let headerImageUrl = '';
      if (headerImage && headerImage.type.startsWith('image/')) {
        headerImageUrl = await uploadFile(headerImage, 'settings');
      }

      const settingsData = {
        title: document.getElementById('siteTitle').value.trim(),
        accentColor: document.getElementById('accentColor').value.trim(),
        welcomeText: document.getElementById('welcomeText').value.trim(),
        updatedAt: new Date().toISOString()
      };
      if (headerImageUrl) {
        settingsData.headerImageUrl = headerImageUrl;
      }

      await setDoc(doc(db, 'settings', 'main'), settingsData, { merge: true });
      alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:', err);
      alert(`–û—à–∏–±–∫–∞: ${err.message}`);
    }
  });

  /* ====== –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (loadStats) ====== */
  async function loadStats() {
    try {
      const [postsSnap, likesSnap, commentsSnap, visitsSnap] = await Promise.all([
        getDocs(collection(db, 'posts')),
        getDocs(collection(db, 'likes')),
        getDocs(collection(db, 'comments')),
        getDocs(collection(db, 'visitors'))
      ]);
      document.getElementById('totalPosts').textContent = postsSnap.size;
      document.getElementById('totalLikes').textContent = likesSnap.size;
      document.getElementById('totalComments').textContent = commentsSnap.size;
      document.getElementById('totalVisitors').textContent = visitsSnap.size;

      // –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å—Ç–æ–≤
      const postsMap = new Map();
      postsSnap.docs.forEach(d => {
        const pData = d.data();
        postsMap.set(d.id, {
          ...pData,
          id: d.id,
          timestamp: pData.timestamp || new Date().toISOString(),
          likes: [],
          comments: []
        });
      });
      likesSnap.docs.forEach(l => {
        const likeData = l.data();
        if (postsMap.has(likeData.postId)) {
          postsMap.get(likeData.postId).likes.push(likeData);
        }
      });
      commentsSnap.docs.forEach(c => {
        const comData = c.data();
        if (postsMap.has(comData.postId)) {
          postsMap.get(comData.postId).comments.push(comData);
        }
      });

      const detailedBlock = document.getElementById('detailedPostStats');
      let html = '';
      postsMap.forEach(post => {
        const dateObj = new Date(post.timestamp);
        const dateStr = dateObj.toLocaleString('ru-RU');
        html += `
          <div class="post-stat-item">
            <div class="post-stat-header">
              <div class="post-title">${post.description ? (post.description.slice(0, 50) + '...') : '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
              <div class="post-date">${dateStr}</div>
            </div>
            <div class="post-stat-details">
              <div>–õ–∞–π–∫–æ–≤: ${post.likes.length}</div>
              <div>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: ${post.comments.length}</div>
              ${
                post.likes.length > 0
                  ? `<div class="likes-details">
                       <small>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–∞–π–∫–∏:</small>
                       ${post.likes.slice(0, 3).map(l => {
                         const ts = (l.timestamp?.toDate?.() || new Date()).toLocaleString('ru-RU');
                         return `<div>${l.userEmail || '–ì–æ—Å—Ç—å'} - ${ts}</div>`;
                       }).join('')}
                     </div>`
                  : ''
              }
            </div>
          </div>`;
      });
      detailedBlock.innerHTML = html;
      loadActivityData('likes'); // –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', err);
    }
  }

  /* ====== –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (showActivityTab) ====== */
  window.showActivityTab = function(tab) {
    document.querySelectorAll('.activity-tab').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`[onclick="showActivityTab('${tab}')"]`).classList.add('active');
    loadActivityData(tab);
  };

// –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–≤–µ—Å—Ç–æ–≤ –∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Ç–∞–±–ª–∏—Ü—É #questStatsTable
async function loadQuestStats() {
  const statsTable = document.getElementById('questStatsTable').querySelector('tbody');
  statsTable.innerHTML = '<tr><td colspan="3">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';

  try {
    const [progressSnap, usersSnap] = await Promise.all([
      getDocs(collection(db, 'userProgress')),
      getDocs(collection(db, 'userProfiles'))
    ]);

    // –°–æ–∑–¥–∞—ë–º –º–∞–ø—É: userId -> –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userMap = {};
    usersSnap.forEach(doc => {
      const data = doc.data();
      userMap[doc.id] = data.displayName || data.username || data.first_name || doc.id;
    });

    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ userProgress
    const dataRows = [];
    progressSnap.forEach(doc => {
      const data = doc.data();
      const id = doc.id;
      dataRows.push({
        id,
        name: userMap[id] || id,
        level: data.maxLevel || '-',
        date: data.lastUpdate?.toDate().toLocaleString('ru-RU') || '-'
      });
    });

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é —É—Ä–æ–≤–Ω—è
    dataRows.sort((a, b) => {
      const aLvl = (typeof a.level === 'number') ? a.level : 0;
      const bLvl = (typeof b.level === 'number') ? b.level : 0;
      return bLvl - aLvl;
    });

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É
    statsTable.innerHTML = dataRows.map(user => `
      <tr>
        <td style="padding:8px;">${user.name}</td>
        <td style="padding:8px;">${user.level}</td>
        <td style="padding:8px;">${user.date}</td>
      </tr>
    `).join('');
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–≤–µ—Å—Ç–æ–≤:", err);
    statsTable.innerHTML = '<tr><td colspan="3" style="color:red">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
  }
}




  /* ====== –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–ª–∞–π–∫–∏, –∫–æ–º–º–µ–Ω—Ç—ã, –ø–æ—Å–µ—â–µ–Ω–∏—è) ====== */
  async function loadActivityData(tab) {
    const userActivity = document.getElementById('userActivity');
    try {
      let snap;
      switch (tab) {
        case 'likes':
          snap = await getDocs(query(collection(db, 'likes'), orderBy('timestamp', 'desc')));
          break;
        case 'comments':
          snap = await getDocs(query(collection(db, 'comments'), orderBy('timestamp', 'desc')));
          break;
        case 'visits':
          snap = await getDocs(query(collection(db, 'visitors'), orderBy('timestamp', 'desc')));
          break;
      }
      if (!snap || snap.empty) {
        userActivity.innerHTML = `<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>`;
        return;
      }
      let html = '';
      snap.docs.forEach(docItem => {
        const data = docItem.data();
        const ts = data.timestamp?.toDate?.() || new Date(data.timestamp || Date.now());
        const dateStr = ts.toLocaleString('ru-RU');
        html += `
          <div class="user-activity-item">
            <img src="${data.userPhoto || '/default-avatar.png'}" alt="User" class="user-photo">
            <div class="activity-info">
              <div class="user-email">${data.displayName || data.username || data.userEmail || '–ì–æ—Å—Ç—å'}</div>
              <div class="activity-date">${dateStr}</div>
              ${
                tab === 'comments'
                  ? `<div class="comment-text">${data.text || ''}</div>
                     <button class="delete-btn" onclick="deleteComment('${docItem.id}', '${data.postId || ''}')">–£–¥–∞–ª–∏—Ç—å</button>`
                  : ''
              }
            </div>
          </div>`;
      });
      userActivity.innerHTML = html;
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:', err);
      userActivity.innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
    }
  }

  /* ====== –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è (deleteComment) ====== */
  window.deleteComment = async function(commentId, postId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?')) return;
    try {
      const batch = writeBatch(db);
      batch.delete(doc(db, 'comments', commentId));

      if (postId) {
        const postRef = doc(db, 'posts', postId);
        const postSnap = await getDoc(postRef);
        if (postSnap.exists()) {
          const currentCount = postSnap.data().commentsCount || 0;
          batch.update(postRef, { commentsCount: Math.max(0, currentCount - 1) });
        }
      }
      await batch.commit();
      loadActivityData('comments');
      loadStats();
      alert('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω');
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:', err);
      alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
    }
  };
// ==== –§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ====
window.editPost = async function(postId) {
  const docSnap = await getDoc(doc(db, 'posts', postId));
  if (!docSnap.exists()) return alert('–ü–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
  const data = docSnap.data();

  showTab('posts');
  document.getElementById('category').value = data.category;
  document.getElementById('category').dispatchEvent(new Event('change'));

  // 1) —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —Å—Ç–∞—Ä—ã–µ URL—ã
  window.editingFileURL  = data.fileURL || '';
  window.editingCoverURL = data.coverURL || '';

  // 2) –ø—Ä—è—á–µ–º –≤—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
  document.getElementById('fileInputGroup').style.display     = 'none';
  document.getElementById('youtubeLinkGroup').style.display   = 'none';

  // 3) –∑–∞–ø–æ–ª–Ω—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –º–µ—Ç–∞-–¥–∞–Ω–Ω—ã–µ
  document.getElementById('description').value = data.description || '';
  document.getElementById('trackDate').value   = data.trackDate   || '';
document.getElementById('taskHint').value = data.taskHint || '';

// ‚Äî –ø—Ä–æ—Å—Ç–∞–≤–ª—è–µ–º –∞—Ä—Ö–∏–≤–Ω—ã–µ –ø–æ–ª—è ‚Äî
isArchiveCh.checked = data.isArchive || false;
isArchiveCh.dispatchEvent(new Event('change'));

if (data.archiveSeq)     document.getElementById('archiveSeq').value     = data.archiveSeq;
if (data.unlockType)     unlockType.value                              = data.unlockType;
unlockType.dispatchEvent(new Event('change'));

if (data.unlockPassword) document.getElementById('unlockPassword').value = data.unlockPassword;
if (data.unlockQuiz)     document.getElementById('unlockQuiz').value     = JSON.stringify(data.unlockQuiz, null, 2);


  // 4) –µ—Å–ª–∏ –µ—Å—Ç—å –æ–±–ª–æ–∂–∫–∞ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º preview
  if (window.editingCoverURL) {
    document.getElementById('coverPreview').innerHTML =
      `<img src="${window.editingCoverURL}" alt="Cover">`;
  }
/* –∑–∞–≥—Ä—É–∂–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å */
if (data.unlockQuiz?.length) {
  quizBuilder.innerHTML = '';          // –æ—á–∏—â–∞–µ–º
  data.unlockQuiz.forEach(addQuestion);// —Ä–∏—Å—É–µ–º –±–ª–æ–∫–∏
  unlockType.value = 'quiz';
  unlockType.dispatchEvent(new Event('change'));
}

  window.editingPostId = postId;
};


  /* ====== –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (DOM –≥–æ—Ç–æ–≤) ====== */
  document.addEventListener('DOMContentLoaded', () => {
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–∞–≥—Ä—É–∑–∫–∏: loadPosts(), loadSettings(), etc.
    // –ù–æ –æ–Ω–∏ –±—É–¥—É—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–≤ onAuthStateChanged)
  });
</script>
</body>
</html>
